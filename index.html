<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master of Medicine (Rural) - Postgraduate Portfolio</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Design & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
            }

            #sidebar.open {
                transform: translateX(0);
            }
        }

        @media print {
            .no-print {
                display: none !important;
            }

            body {
                background: white;
                font-size: 11pt;
            }

            .shadow-sm {
                box-shadow: none;
                border: 1px solid #e2e8f0;
            }

            main {
                margin-left: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }

            table {
                page-break-after: auto;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            td {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans flex min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading"
        class="fixed inset-0 bg-slate-900 bg-opacity-90 z-50 hidden flex-col items-center justify-center text-white space-y-4">
        <i class="fas fa-circle-notch fa-spin text-4xl text-teal-400"></i>
        <span class="font-medium tracking-wide">Syncing Data...</span>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-slate-900 bg-opacity-50 z-40 hidden md:hidden fade-in"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="w-64 bg-slate-900 text-slate-300 flex flex-col min-h-screen shadow-xl no-print md:translate-x-0 fixed md:sticky top-0 h-screen overflow-y-auto">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-950">
            <div class="flex items-center gap-3">
                <i class="fas fa-user-md text-teal-500 text-2xl"></i>
                <h2 class="text-lg font-bold text-white tracking-tight">MMed Rural</h2>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i
                    class="fas fa-times text-xl"></i></button>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-1">
            <button onclick="state.setTab('dashboard')" id="tab-dashboard"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-left">
                <i class="fas fa-chart-pie w-5 text-center"></i> Dashboard
            </button>
            <button onclick="state.setTab('master_logbook')" id="tab-master_logbook"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-left">
                <i class="fas fa-clipboard-check w-5 text-center"></i> Master Logbook
            </button>
            <button onclick="state.setTab('milestones')" id="tab-milestones"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-left">
                <i class="fas fa-flag-checkered w-5 text-center"></i> Milestones & Courses
            </button>

            <div class="pt-6 pb-2">
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Clinical Modules</p>
            </div>

            <div id="module-nav-links" class="space-y-1">
                <!-- Modules injected by JS -->
            </div>
        </nav>

        <div class="p-4 border-t border-slate-800 space-y-2">
            <button onclick="state.logout()"
                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg transition-colors text-sm font-medium">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div id="main-layout" class="flex-1 flex flex-col min-h-screen w-full hidden">
        <!-- Mobile Header -->
        <header
            class="bg-teal-700 text-white shadow-md sticky top-0 z-30 md:hidden flex justify-between items-center p-4 no-print">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="text-white focus:outline-none"><i
                        class="fas fa-bars text-xl"></i></button>
                <span class="font-bold">Portfolio</span>
            </div>
            <button onclick="window.print()"><i class="fas fa-print"></i></button>
        </header>

        <main id="app-container" class="flex-1 p-4 md:p-8 lg:px-12 w-full max-w-6xl mx-auto fade-in">
            <!-- Rendered by JS -->
        </main>
    </div>

    <!-- Login Container -->
    <div id="login-container" class="flex-1 min-h-screen bg-slate-900 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden fade-in">
            <div class="bg-slate-800 p-8 text-center border-b border-slate-700">
                <div
                    class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-700 mb-4 ring-4 ring-slate-600">
                    <i class="fas fa-user-md text-3xl text-teal-400"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight">MMed Rural Portfolio</h1>
                <p class="text-slate-400 text-sm mt-1">Please sign in to continue</p>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Email Address</label>
                    <input type="email" id="login-email"
                        class="w-full border border-slate-300 rounded-lg px-4 py-3 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Password</label>
                    <input type="password" id="login-password"
                        class="w-full border border-slate-300 rounded-lg px-4 py-3 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                </div>
                <button onclick="state.signInEmail()"
                    class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                    Sign In with Email
                </button>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-400 text-xs font-semibold uppercase">OR</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <button onclick="state.signInGoogle()"
                    class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-semibold py-3 rounded-lg flex items-center justify-center gap-3 transition-colors">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                    Continue with Google
                </button>
            </div>
            <div class="bg-slate-50 p-4 text-center text-xs text-slate-500 border-t border-slate-100">
                Authorized Access Only &bull; Papua New Guinea Medical Board
            </div>
        </div>
    </div>

    <!-- Quick Log FAB -->
    <button id="fab-btn" onclick="showQuickLogModal()"
        class="hidden fixed bottom-6 right-6 w-14 h-14 bg-teal-600 hover:bg-teal-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all items-center justify-center text-2xl z-40 no-print hover:scale-105">
        <i class="fas fa-plus"></i>
    </button>

    <script>
        // --- DATA CONFIGURATIONS (From User Input) ---
        const moduleConfigs = [
            { id: 'surgery', name: 'Surgery (Module 1)', color: 'bg-green-700', text: 'text-green-700', border: 'border-green-700', duration: '9 months', weeks: [{ id: 'w1', title: 'Trauma Assessment & Shock' }, { id: 'w2', title: 'Antibiotics & Pre-op Prep' }, { id: 'w3', title: 'Instruments & Sterilization' }, { id: 'w4', title: 'Theatre Setup' }, { id: 'w5', title: 'Acute Pain' }, { id: 'w6', title: 'Chronic Pain' }, { id: 'w7', title: 'Wounds & Suturing' }, { id: 'w8', title: 'Transfer Principles' }, { id: 'w9', title: 'Pyomyositis & Osteo' }, { id: 'w10', title: 'Chest Drains' }, { id: 'w11', title: 'Closed Fractures' }, { id: 'w12', title: 'Neurovascular' }, { id: 'w13', title: 'Dental/Airway Infections' }, { id: 'w14', title: 'Abscesses' }, { id: 'w15', title: 'Appendicitis' }, { id: 'w16', title: 'Laparotomy Basics' }, { id: 'w17', title: 'Gut Repair' }, { id: 'w18', title: 'Stomas & Ulcers' }, { id: 'w19', title: 'Bowel Obstruction' }, { id: 'w20', title: 'Casting & Splinting' }, { id: 'w21', title: 'Traction' }, { id: 'w22', title: 'Open Fractures' }, { id: 'w23', title: 'Dislocations' }, { id: 'w24', title: 'Upper Limb Trauma' }, { id: 'w25', title: 'Bleeding Control' }, { id: 'w26', title: 'Enucleation' }, { id: 'w27', title: 'Hernia Repair' }, { id: 'w28', title: 'Strangulated Hernia' }, { id: 'w29', title: 'Minor Procedures' }, { id: 'w30', title: 'Head & Spinal Injury' }, { id: 'w31', title: 'Burns' }, { id: 'w32', title: 'Ethics' }], assignmentList: ['1. Cancer Pathophysiology', '2. Cancer Screening in PNG', '3. Blood Transfusion Protocols', '4. Blood / Haemopoiesis', '5. Cytokines', '6. Wound Healing Physiology', '7. Hb & Oxygen Transport', '8. Genetics', '9. Nerve Conduction', '10. Pain Pathways', '11. Urodynamics', '12. CSF & ICP', '13. Calcium Homeostasis', '14. Liver Function', '15. Bile & Gallstones', '16. Oedema', '17. Thrombosis', '18. Gastric Secretion', '19. Surgical Infections', '20. Antibiotics Policy'], requiredProcedures: [{ name: 'Pleural tap (thoracoscentesis)', target: 3 }, { name: 'Abdominal tap (parascentesis)', target: 2 }, { name: 'Insertion of a chest drain', target: 5 }, { name: 'Debriding a wound', target: 3 }, { name: 'Doing an appendicectomy', target: 3 }, { name: 'Repair of inguinal hernia', target: 2 }, { name: 'Cesarean Section', target: 6 }, { name: 'Laparotomy', target: 5 }] },
            { id: 'anaesthesia', name: 'Anaesthesiology (Module 2)', color: 'bg-slate-700', text: 'text-slate-700', border: 'border-slate-700', duration: '4 months', weeks: [{ id: 'w1', title: 'Machine Check & Equipment' }, { id: 'w2', title: 'Ketamine (Pharma & Use)' }, { id: 'w3', title: 'Propofol & Benzos' }, { id: 'w4', title: 'Pre-op Assessment' }, { id: 'w5', title: 'Opiates & Deferring Surgery' }, { id: 'w6', title: 'Chronic Pain' }, { id: 'w7', title: 'Spinal & LUSCS' }, { id: 'w8', title: 'Brachial Plexus Blocks' }, { id: 'w9', title: 'Wrist/Ankle Blocks' }, { id: 'w10', title: 'Neonatal Resuscitation' }, { id: 'w11', title: 'Cannot Intubate/Ventilate' }, { id: 'w12', title: 'IV Access' }, { id: 'w13', title: 'Cardiac Arrest' }, { id: 'w14', title: 'Handling Negative Outcomes' }], caseReports: ['General Anaesthesia', 'Ketamine', 'Spinal', 'Paediatric', 'Resuscitation'], requiredProcedures: [{ name: 'Adult intubation', target: 10 }, { name: 'Spinal (pregnant)', target: 10 }, { name: 'Spinal (non-pregnant)', target: 10 }, { name: 'Ketamine', target: 10 }] },
            { id: 'childhealth', name: 'Child Health (Module 3)', color: 'bg-orange-500', text: 'text-orange-500', border: 'border-orange-500', duration: '1 month', weeks: [{ id: 'w1', title: 'Milestones & Malnutrition' }, { id: 'w2', title: 'Pneumonia & Oxygen' }, { id: 'w3', title: 'Cardiac & Kidney' }, { id: 'w4', title: 'Newborn Exam' }, { id: 'w5', title: 'Ponsetti & Diarrhoea' }, { id: 'w6', title: 'Immunization' }], caseReports: ['Pneumonia', 'Diarrhoea', 'Malnutrition', 'Meningitis', 'Neonatal Sepsis'], requiredProcedures: [{ name: 'Neonatal resuscitation', target: 4 }, { name: 'Management of LBW neonate', target: 4 }, { name: 'Intraosseous needle placement', target: 1 }] },
            { id: 'obs_gyn', name: 'Obs & Gynae (Module 4)', color: 'bg-pink-500', text: 'text-pink-500', border: 'border-pink-500', duration: '3 months', weeks: [{ id: 'w1', title: 'Menstrual Cycle' }, { id: 'w2', title: 'Contraception' }, { id: 'w3', title: 'Routine Antenatal' }, { id: 'w4', title: 'Basic USS' }, { id: 'w5', title: 'Miscarriage/Ectopic' }, { id: 'w6', title: 'Normal Labour' }, { id: 'w7', title: 'Partograms' }, { id: 'w8', title: 'CS Technique' }, { id: 'w9', title: 'APH & Pre-eclampsia' }, { id: 'w10', title: 'Failure to Progress' }, { id: 'w11', title: 'PPH' }, { id: 'w12', title: 'Puerperal Sepsis' }, { id: 'w13', title: 'Infertility' }, { id: 'w15', title: 'Ovarian Tumours' }, { id: 'w17', title: 'Endometrial CA' }, { id: 'w19', title: 'Cervical CA' }, { id: 'w21', title: 'Pelvic Sepsis' }, { id: 'w23', title: 'Pre-eclampsia/Eclampsia' }, { id: 'w26', title: 'PPH Advanced' }, { id: 'w29', title: 'Destructive Delivery' }], assignmentList: ['1. Family Planning', '2. Supervised Birthing Rates', '3. Cervical Cancer'], requiredProcedures: [{ name: 'Management of PPH', target: 6 }, { name: 'Breech delivery', target: 5 }, { name: 'Vacuum extraction', target: 6 }, { name: 'ERPC', target: 6 }] },
            { id: 'medicine', name: 'Internal Medicine (Module 5)', color: 'bg-blue-600', text: 'text-blue-600', border: 'border-blue-600', duration: '2 months', weeks: [{ id: 'w1', title: 'Diabetes' }, { id: 'w2', title: 'Antibiotics & Sepsis' }, { id: 'w3', title: 'Tuberculosis' }, { id: 'w4', title: 'Snake Bite & ECG' }, { id: 'w5', title: 'Hypertension & HIV' }, { id: 'w6', title: 'Asthma/COAD' }], caseReports: ['Severe malaria', 'Severe Asthma', 'Epilepsy', 'Tuberculosis'], requiredProcedures: [{ name: 'Severe malaria management', target: 4 }, { name: 'Tuberculosis management', target: 6 }, { name: 'HIV/AIDS management', target: 4 }, { name: 'Perform an ECG', target: 4 }, { name: 'Lumbar puncture', target: 2 }] },
            { id: 'psychiatry', name: 'Psychiatry (Module 6)', color: 'bg-purple-500', text: 'text-purple-500', border: 'border-purple-500', duration: '1 month', caseReports: ['Acute Psychosis', 'Somatoform Disorder'], requiredProcedures: [] },
            { id: 'publichealth', name: 'Public Health (Module 7)', color: 'bg-teal-500', text: 'text-teal-500', border: 'border-teal-500', duration: 'Longitudinal', assignmentList: ['Part A: District Health Report', 'Part B: Outbreak of Food Poisoning', 'Part B: Disease Surveillance'], requiredProcedures: [] },
            { id: 'eye_ent', name: 'Eye/ENT (Module 8)', color: 'bg-cyan-500', text: 'text-cyan-500', border: 'border-cyan-500', duration: '1 month', caseReports: ['Eye Injury', 'Red Eye', 'Epistaxis'], requiredProcedures: [{ name: 'Remove foreign body', target: 2 }] },
            { id: 'lab', name: 'Laboratory (Module 9)', color: 'bg-indigo-500', text: 'text-indigo-500', border: 'border-indigo-500', duration: '1 month', assignmentList: ['Cross-match', 'Malaria Stain'], requiredProcedures: [{ name: 'Blood grouping', target: 4 }, { name: 'HIV Rapid test', target: 2 }, { name: 'Giemsa stain', target: 2 }] },
            { id: 'management', name: 'Management (Module 10)', color: 'bg-slate-600', text: 'text-slate-600', border: 'border-slate-600', duration: '4 weeks', assignmentList: ['Management Systems Essay'], requiredProcedures: [] }
        ];

        const milestoneConfigs = {
            research: [{ id: 'res_topic', label: 'Research Topic Approved' }, { id: 'res_data', label: 'Data Collection Completed' }, { id: 'res_submit', label: 'Research Submitted' }, { id: 'res_present', label: 'Research Presented' }],
            exams: [{ id: 'exam_part1', label: 'Part 1 Exam Passed' }, { id: 'exam_part2_written', label: 'Part 2 Written Passed' }, { id: 'exam_part2_clinical', label: 'Part 2 Clinical Passed' }],
            management: [{ id: 'mgmt_course', label: '4-Week Intensive Course Completed' }, { id: 'mgmt_assign', label: 'Assignment Completed' }],
            other: [{ id: 'sc_emst', label: 'EMST Course' }, { id: 'sc_emsb', label: 'EMSB Course' }, { id: 'sc_us', label: 'Basic Ultrasonography' }, { id: 'sc_als', label: 'Advanced Life Support' }]
        };


        // --- APP STATE (Merged with Firebase) ---
        class AppState {
            constructor() {
                this.account = null; // Start null to force login
                this.modules = {};
                this.procedureLog = [];
                this.milestones = {};
                this.activeTab = 'dashboard';
                this.listeners = [];
                this._loginHandled = false;

                // Init modules structure
                moduleConfigs.forEach(m => { this.modules[m.id] = { assignments: {}, weeks: {}, caseReports: {} }; });

                this.initFirebase();
                this.loadData(); // Load local storage check
            }

            initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyBhEln9kmgq22NnNHI83eUH7_d6S4F1O5s",
                    authDomain: "rural-mmed-logbook-3e095.firebaseapp.com",
                    projectId: "rural-mmed-logbook-3e095",
                    storageBucket: "rural-mmed-logbook-3e095.firebasestorage.app",
                    messagingSenderId: "826477177641",
                    appId: "1:826477177641:web:fe9de6e733b442fdffe538"
                };

                try {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    this.auth = firebase.auth();
                    this.db = firebase.firestore();

                    // Guarded Redirect Check
                    if (!this.auth.currentUser) {
                        this.auth.getRedirectResult().then(result => {
                            if (result.user) this.handleCloudLogin(result.user);
                        }).catch(e => console.error("Redirect Error:", e));
                    }

                    this.auth.onAuthStateChanged(user => {
                        if (user) this.handleCloudLogin(user);
                        else {
                            this.account = null;
                            this.notify(); // Triggers renderLogin
                        }
                    });
                } catch (e) { console.error("Firebase Init Failed", e); }
            }

            async handleCloudLogin(user) {
                if (this._loginHandled && this.account && this.account.id === user.uid) return;
                this._loginHandled = true;

                document.getElementById('loading').style.display = 'flex';

                try {
                    const doc = await this.db.collection('users').doc(user.uid).get();
                    const cloudData = doc.exists ? doc.data() : {};

                    this.account = {
                        name: cloudData.account?.name || user.displayName || "Dr. Trainee",
                        email: user.email,
                        id: user.uid,
                        year: cloudData.account?.year || 1,
                        location: cloudData.account?.location || "General Hospital"
                    };

                    // Merge Module Data
                    if (cloudData.modules) this.modules = cloudData.modules;
                    if (cloudData.procedureLog) this.procedureLog = cloudData.procedureLog;
                    if (cloudData.milestones) this.milestones = cloudData.milestones;

                    this.saveData(true); // Save local copy
                } catch (e) {
                    console.error("Sync Error", e);
                    this.account = { name: user.displayName || "Dr. User", email: user.email, id: user.uid, year: 1, location: "Offline" };
                } finally {
                    document.getElementById('loading').style.display = 'none';
                    this.notify();
                }
            }

            loadData() {
                // Initial check for local data
                const stored = localStorage.getItem('mmed_tracker_v2_cloud');
                if (stored) {
                    const data = JSON.parse(stored);
                    if (data.account && data.account.id) {
                        this.account = data.account;
                        this.modules = data.modules || this.modules;
                        this.procedureLog = data.procedureLog || [];
                        this.milestones = data.milestones || {};
                    }
                }
            }

            saveData(skipCloud = false) {
                const data = { account: this.account, modules: this.modules, procedureLog: this.procedureLog, milestones: this.milestones };
                localStorage.setItem('mmed_tracker_v2_cloud', JSON.stringify(data));

                if (!skipCloud && this.account && this.db && this.account.id) {
                    this.db.collection('users').doc(this.account.id).set(data, { merge: true }).catch(e => console.error("Cloud Save Failing:", e));
                }
                this.notify();
            }

            // Auth Methods
            signInGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                this.auth.signInWithPopup(provider)
                    .then(r => this.handleCloudLogin(r.user))
                    .catch(e => {
                        console.warn("Popup blocked, trying redirect");
                        this.auth.signInWithRedirect(provider);
                    });
            }

            signInEmail() {
                const e = document.getElementById('login-email').value;
                const p = document.getElementById('login-password').value;
                if (!e || !p) return alert("Please enter email and password");

                this.auth.signInWithEmailAndPassword(e, p).catch(err => {
                    if (err.code === 'auth/user-not-found') {
                        if (confirm("User not found. Register new account?")) {
                            this.auth.createUserWithEmailAndPassword(e, p).then(r => this.handleCloudLogin(r.user));
                        }
                    } else alert(err.message);
                });
            }

            logout() {
                this._loginHandled = false;
                if (this.auth) this.auth.signOut();
                this.account = null;
                // WIPE LOCAL DATA
                localStorage.removeItem('mmed_tracker_v2_cloud');

                this.notify();
                location.reload();
            }

            // App Actions
            setTab(tab) {
                this.activeTab = tab;
                if (window.innerWidth <= 768 && document.getElementById('sidebar').classList.contains('open')) toggleSidebar();
                this.notify();
            }

            updateModuleData(moduleId, type, id, value) {
                if (type === 'week') {
                    if (!this.modules[moduleId].weeks[id]) this.modules[moduleId].weeks[id] = {};
                    if (typeof value === 'object') this.modules[moduleId].weeks[id] = { ...this.modules[moduleId].weeks[id], ...value };
                    else this.modules[moduleId].weeks[id].status = value;
                } else if (type === 'assignment') {
                    if (!this.modules[moduleId].assignments[id]) this.modules[moduleId].assignments[id] = {};
                    this.modules[moduleId].assignments[id] = { ...this.modules[moduleId].assignments[id], ...value };
                } else if (type === 'caseReport') {
                    this.modules[moduleId].caseReports[id] = value;
                }
                this.saveData();
            }

            addProcedure(data) {
                this.procedureLog.push({ ...data, timestamp: Date.now() });
                this.saveData();
            }

            updateMilestone(category, id, value, date) {
                if (!this.milestones[category]) this.milestones[category] = {};
                this.milestones[category][id] = { status: value, date: date };
                this.saveData();
            }

            notify() { this.listeners.forEach(l => l()); }
            subscribe(l) { this.listeners.push(l); }
        }

        const state = new AppState();

        // --- RENDER FUNCTIONS (Tailwind) ---

        function renderSidebarLinks() {
            const container = document.getElementById('module-nav-links');
            container.innerHTML = moduleConfigs.map(m => `
                <button onclick="state.setTab('${m.id}')" id="tab-${m.id}" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800 transition-colors text-sm text-left truncate">
                    <div class="w-3 h-3 rounded-full ${m.color}"></div>
                    <span class="truncate">${m.name.split(' (')[0]}</span>
                </button>
            `).join('');

            // Active Tab Styles
            document.querySelectorAll('aside button').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white', 'border-l-4', 'border-teal-500');
                if (btn.id === `tab-${state.activeTab}`) {
                    btn.classList.add('bg-slate-800', 'text-white', 'border-l-4', 'border-teal-500', 'pl-2');
                }
            });
        }

        function renderDashboard() {
            const totalProcedures = state.procedureLog.length;
            const targetProcedures = moduleConfigs.reduce((acc, m) => acc + (m.requiredProcedures?.reduce((a, p) => a + p.target, 0) || 0), 0);
            const totalAssignments = Object.values(state.modules).reduce((acc, m) => acc + (m.assignments ? Object.values(m.assignments).filter(a => a.dateSubmitted).length : 0), 0);

            return `
                <div class="flex justify-between items-end mb-8 no-print">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Dashboard</h1>
                        <p class="text-slate-500 mt-1">Welcome back, Dr. ${state.account.name}</p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8 border-l-4 border-l-slate-800">
                    <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">Profile Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Name</label>
                            <input value="${state.account.name}" onchange="state.account.name=this.value; state.saveData()" class="w-full border border-slate-300 rounded p-2">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Year</label>
                            <select onchange="state.account.year=parseInt(this.value); state.saveData(); state.notify()" class="w-full border border-slate-300 rounded p-2">
                                ${[1, 2, 3, 4, 5, 6].map(y => `<option value="${y}" ${state.account.year === y ? 'selected' : ''}>Year ${y}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Hospital</label>
                            <input value="${state.account.location || ''}" onchange="state.account.location=this.value; state.saveData()" class="w-full border border-slate-300 rounded p-2">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-teal-600">
                        <h3 class="text-slate-500 text-sm uppercase font-bold tracking-wider mb-2">Procedures Logged</h3>
                        <div class="flex items-end gap-2">
                            <span class="text-4xl font-black text-slate-800">${totalProcedures}</span>
                            <span class="text-slate-400 font-medium mb-1">/ ${targetProcedures} Total</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-amber-600">
                        <h3 class="text-slate-500 text-sm uppercase font-bold tracking-wider mb-2">Assignments</h3>
                        <div class="flex items-end gap-2">
                            <span class="text-4xl font-black text-slate-800">${totalAssignments}</span>
                            <span class="text-slate-400 font-medium mb-1">Submitted</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Re-using user's render logic for Milestones/MasterLog/Details (simplified for brevity but functionally identical)
        function renderMilestones() {
            return `
                <h1 class="text-3xl font-bold text-slate-800 mb-6">Milestones</h1>
                ${Object.keys(milestoneConfigs).map(cat => `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-6 overflow-hidden">
                        <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 font-bold uppercase text-xs tracking-wider">${cat}</div>
                        <div class="divide-y divide-slate-100">
                            ${milestoneConfigs[cat].map(m => {
                const mData = state.milestones[cat]?.[m.id] || {};
                const isDone = mData.status === 'Done' || mData.status === 'Passed';
                return `
                                <div class="p-4 flex flex-col sm:flex-row justify-between items-center gap-4 ${isDone ? 'bg-green-50' : ''}">
                                    <span class="font-medium text-slate-700">${m.label}</span>
                                    <div class="flex gap-2">
                                        <select onchange="state.updateMilestone('${cat}','${m.id}',this.value, this.nextElementSibling.value)" class="border rounded px-2 py-1 text-sm ${isDone ? 'bg-green-600 text-white' : ''}">
                                            <option value="Pending">Pending</option>
                                            <option value="Done" ${isDone ? 'selected' : ''}>Done</option>
                                        </select>
                                        <input type="date" value="${mData.date || ''}" onchange="state.updateMilestone('${cat}','${m.id}',this.previousElementSibling.value,this.value)" class="border rounded px-2 py-1 text-sm">
                                    </div>
                                </div>`;
            }).join('')}
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function renderMasterLogbook() {
            return `
                <div class="flex justify-between items-end mb-8 no-print">
                    <h1 class="text-3xl font-bold text-slate-800">Master Logbook</h1>
                    <button onclick="window.print()" class="bg-slate-100 px-4 py-2 rounded-lg font-medium hover:bg-slate-200"><i class="fas fa-print mr-2"></i> Print</button>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${moduleConfigs.filter(m => m.requiredProcedures?.length).map(m => `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 break-inside-avoid">
                            <h3 class="font-bold ${m.text} mb-4 border-b pb-2">${m.name}</h3>
                            ${m.requiredProcedures.map(req => {
                const count = state.procedureLog.filter(p => p.moduleId === m.id && p.procedure === req.name).length;
                const isDone = count >= req.target;
                return `
                                    <div class="flex justify-between text-sm mb-2">
                                        <span class="${isDone ? 'text-green-700 font-medium' : ''}">${req.name}</span>
                                        <span class="${isDone ? 'text-green-600 font-bold' : 'text-slate-400'}">${count} / ${req.target}</span>
                                    </div>
                                    <div class="h-1.5 bg-slate-100 rounded-full mb-3 no-print">
                                        <div class="h-1.5 rounded-full ${isDone ? 'bg-green-500' : 'bg-teal-500'}" style="width:${Math.min(100, (count / req.target) * 100)}%"></div>
                                    </div>
                                `;
            }).join('')}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderModuleDetail(mid) {
            const conf = moduleConfigs.find(c => c.id === mid);
            const data = state.modules[mid];
            const logs = state.procedureLog.filter(p => p.moduleId === mid);

            return `
                <div class="${conf.color} rounded-2xl p-8 text-white mb-8 shadow-md">
                    <h1 class="text-3xl font-bold">${conf.name}</h1>
                    <div class="flex gap-4 mt-2 text-white/80 text-sm">
                        <span><i class="far fa-clock"></i> ${conf.duration}</span>
                    </div>
                </div>

                ${conf.weeks ? `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
                    <h3 class="font-bold text-slate-800 mb-4 pb-2 border-b">Clinical Schedule</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${conf.weeks.map(w => {
                const st = data.weeks[w.id]?.status || 'Not Started';
                return `<div class="border rounded p-3 ${st === 'Completed' ? 'bg-green-50 border-green-200' : ''}">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="font-bold text-sm text-slate-700">${w.title}</div>
                                    <select onchange="state.updateModuleData('${mid}','week','${w.id}',{status:this.value})" class="text-xs border rounded px-1 py-1 ${st === 'Completed' ? 'bg-green-600 text-white' : ''}">
                                        <option ${st === 'Not Started' ? 'selected' : ''}>Not Started</option>
                                        <option ${st === 'Pending' ? 'selected' : ''}>Pending</option>
                                        <option ${st === 'Completed' ? 'selected' : ''}>Completed</option>
                                    </select>
                                </div>
                            </div>`;
            }).join('')}
                    </div>
                </div>` : ''}

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-12">
                     <div class="flex justify-between items-center mb-4 border-b pb-2 no-print">
                        <h3 class="font-bold text-slate-800">Procedure Log</h3>
                        <button onclick="window.print()" class="text-sm bg-slate-100 px-3 py-1 rounded hover:bg-slate-200"><i class="fas fa-print"></i> Print</button>
                    </div>
                    
                    <div class="hidden print:block mb-6 pt-4 border-t">
                        <h2 class="text-xl font-bold uppercase text-center">${conf.name} Logbook</h2>
                        <p class="text-center text-sm">Trainee: ${state.account.name}</p>
                    </div>

                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-50 text-slate-500 uppercase text-xs">
                            <tr><th class="px-4 py-2">Date</th><th class="px-4 py-2">Procedure</th><th class="px-4 py-2">Supervisor</th><th class="px-4 py-2 text-right">Signature</th></tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            ${logs.map(p => `
                                <tr>
                                    <td class="px-4 py-3 align-top">${p.date}</td>
                                    <td class="px-4 py-3 font-medium align-top">${p.procedure}</td>
                                    <td class="px-4 py-3 align-top">${p.supervisor}</td>
                                    <td class="px-4 py-3 border-b border-slate-200 h-12"></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }


        // --- MAIN RENDERER ---
        function renderApp() {
            const app = document.getElementById('main-layout');
            const login = document.getElementById('login-container');
            const fab = document.getElementById('fab-btn');

            if (!state.account) {
                app.classList.add('hidden');
                fab.classList.add('hidden');
                login.classList.remove('hidden');
                return;
            }

            // Logged In State
            app.classList.remove('hidden');
            login.classList.add('hidden');
            fab.classList.remove('hidden');

            renderSidebarLinks();

            const container = document.getElementById('app-container');
            if (state.activeTab === 'dashboard') container.innerHTML = renderDashboard();
            else if (state.activeTab === 'milestones') container.innerHTML = renderMilestones();
            else if (state.activeTab === 'master_logbook') container.innerHTML = renderMasterLogbook();
            else container.innerHTML = renderModuleDetail(state.activeTab);

            window.scrollTo(0, 0);
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('mobile-overlay').classList.toggle('hidden');
        }

        // --- QUICK LOG MODAL (Simplified) ---
        function showQuickLogModal() {
            const mid = state.activeTab === 'dashboard' ? '' : state.activeTab;
            const p = prompt("Procedure Name:");
            const s = prompt("Supervisor:");
            if (p && s) {
                state.addProcedure({
                    moduleId: mid || moduleConfigs[0].id,
                    procedure: p,
                    supervisor: s,
                    date: new Date().toISOString().split('T')[0],
                    location: state.account.location
                });
                renderApp();
            }
        }

        // Initial Render
        // State listener handles updates
    </script>
</body>

</html>