<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master of Medicine (Rural) - Postgraduate Portfolio</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #f8fafc;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .fade-in {
            animation: fadeIn 0.2s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sidebar transition for mobile */
        #sidebar {
            transition: transform 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
                position: fixed;
                z-index: 50;
            }

            #sidebar.open {
                transform: translateX(0);
            }
        }

        .section-collapsed .section-chevron {
            transform: rotate(-90deg);
        }

        /* Agent Chat Scrollbar */
        #agent-chat-history::-webkit-scrollbar {
            width: 4px;
        }
        #agent-chat-history::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 4px;
        }

        @media print {
            .no-print {
                display: none !important;
            }

            .print-hide-zero {
                display: none !important;
            }

            body {
                background: white;
                font-size: 11pt;
            }

            .shadow-sm {
                box-shadow: none;
                border: 1px solid #e2e8f0;
            }

            main {
                margin-left: 0 !important;
                padding: 0 !important;
                max-width: 100% !important;
            }

            table {
                page-break-after: auto;
            }

            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            td {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            thead {
                display: table-header-group;
            }

            tfoot {
                display: table-footer-group;
            }
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 font-sans flex min-h-screen">

    <!-- Loading Overlay -->
    <div id="loading"
        class="fixed inset-0 bg-slate-900 bg-opacity-90 z-50 hidden flex-col items-center justify-center text-white space-y-4">
        <i class="fas fa-circle-notch fa-spin text-4xl text-teal-400"></i>
        <span class="font-medium tracking-wide">Syncing Data...</span>
    </div>

    <!-- Backup Modal -->
    <div id="backupModal"
        class="fixed inset-0 bg-slate-900 bg-opacity-90 z-50 hidden flex items-center justify-center p-4 fade-in backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-slate-800"><i class="fas fa-cloud-upload-alt text-teal-500 mr-2"></i>
                    Backup Your Data</h2>
                <button onclick="document.getElementById('backupModal').classList.add('hidden')"
                    class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-6 space-y-6">
                <p class="text-slate-600 text-sm leading-relaxed">
                    Choose how you want to save your portfolio data. Frequent backups prevent data loss!
                </p>

                <button onclick="state.backupToDrive()"
                    class="w-full group relative flex items-center p-4 border-2 border-slate-200 rounded-xl hover:border-teal-500 hover:bg-teal-50 transition-all duration-200 text-left">
                    <div
                        class="w-12 h-12 rounded-full bg-teal-100 flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                        <i class="fab fa-google-drive text-2xl text-teal-600"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="font-bold text-slate-800 group-hover:text-teal-700">Google Drive Backup</h3>
                        <p class="text-xs text-slate-500 mt-1">Save directly to your "MMed Portfolio" folder in the
                            cloud.</p>
                    </div>
                    <div class="absolute right-4 text-slate-300 group-hover:text-teal-500">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </button>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-400 text-xs font-semibold uppercase">OR</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>

                <button onclick="state.exportData()"
                    class="w-full group relative flex items-center p-4 border-2 border-slate-200 rounded-xl hover:border-amber-500 hover:bg-amber-50 transition-all duration-200 text-left">
                    <div
                        class="w-12 h-12 rounded-full bg-amber-100 flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                        <i class="fas fa-file-download text-2xl text-amber-600"></i>
                    </div>
                    <div class="ml-4">
                        <h3 class="font-bold text-slate-800 group-hover:text-amber-700">Download File</h3>
                        <p class="text-xs text-slate-500 mt-1">Save a .json file to this device.</p>
                    </div>
                </button>
            </div>
            <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 text-center">
                <button onclick="document.getElementById('backupModal').classList.add('hidden')"
                    class="text-slate-500 hover:text-slate-700 text-sm font-medium">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Login Container -->
    <div id="login-container" class="fixed inset-0 bg-slate-900 z-40 flex items-center justify-center p-4 hidden">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden fade-in">
            <div class="bg-slate-800 p-8 text-center border-b border-slate-700">
                <div
                    class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-700 mb-4 ring-4 ring-slate-600">
                    <i class="fas fa-user-md text-3xl text-teal-400"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight">MMed Rural Portfolio</h1>
                <p id="login-subtitle" class="text-slate-400 text-sm mt-1">Please sign in to continue</p>
            </div>
            <div class="p-8 space-y-6">
                <div id="signup-name-field" class="hidden">
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Full Name</label>
                    <input type="text" id="login-name" placeholder="Dr. John Doe"
                        class="w-full border border-slate-300 rounded-lg px-4 py-3 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Email Address</label>
                    <input type="email" id="login-email"
                        class="w-full border border-slate-300 rounded-lg px-4 py-3 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Password</label>
                    <div class="relative">
                        <input type="password" id="login-password" placeholder="Min. 6 characters"
                            class="w-full border border-slate-300 rounded-lg px-4 py-3 pr-12 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                        <button type="button" onclick="togglePassword('login-password', this)"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div id="confirm-password-field" class="hidden">
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Confirm Password</label>
                    <div class="relative">
                        <input type="password" id="login-confirm-password"
                            class="w-full border border-slate-300 rounded-lg px-4 py-3 pr-12 outline-none focus:border-teal-500 focus:ring-2 focus:ring-teal-100 transition-all">
                        <button type="button" onclick="togglePassword('login-confirm-password', this)"
                            class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 p-1">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
                <div id="login-error"
                    class="hidden text-sm text-rose-600 bg-rose-50 border border-rose-200 rounded-lg px-4 py-3"></div>
                <button id="auth-submit-btn" onclick="state.signInEmail()"
                    class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                    Sign In
                </button>
                <p id="auth-toggle" class="text-center text-sm text-slate-500">
                    Don't have an account? <a href="#" onclick="toggleAuthMode(event)"
                        class="text-teal-600 font-semibold hover:text-teal-700">Sign Up</a>
                </p>
                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-slate-200"></div>
                    <span class="flex-shrink-0 mx-4 text-slate-400 text-xs font-semibold uppercase">OR</span>
                    <div class="flex-grow border-t border-slate-200"></div>
                </div>
                <button onclick="state.signInGoogle()"
                    class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-semibold py-3 rounded-lg flex items-center justify-center gap-3 transition-colors">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                    Continue with Google
                </button>
            </div>
            <div class="bg-slate-50 p-4 text-center text-xs text-slate-500 border-t border-slate-100">
                &copy; DAC
            </div>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div id="mobile-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-slate-900 bg-opacity-50 z-40 hidden md:hidden fade-in"></div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="w-64 bg-slate-900 text-slate-300 flex flex-col min-h-screen shadow-xl no-print md:translate-x-0 fixed md:sticky top-0 h-screen overflow-y-auto">
        <div class="p-6 border-b border-slate-800 flex justify-between items-center bg-slate-950">
            <div class="flex items-center gap-3">
                <i class="fas fa-user-md text-teal-500 text-2xl"></i>
                <h2 class="text-lg font-bold text-white tracking-tight">MMed Rural</h2>
            </div>
            <button onclick="toggleSidebar()" class="md:hidden text-slate-400 hover:text-white"><i
                    class="fas fa-times text-xl"></i></button>
        </div>

        <nav class="flex-1 px-4 py-6 space-y-1">
            <button onclick="state.setTab('dashboard')" id="tab-dashboard"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-left">
                <i class="fas fa-chart-pie w-5 text-center"></i> Dashboard
            </button>
            <button onclick="state.setTab('master_logbook')" id="tab-master_logbook"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-left">
                <i class="fas fa-clipboard-check w-5 text-center"></i> Master Logbook
            </button>
            <button onclick="state.setTab('milestones')" id="tab-milestones"
                class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg hover:bg-slate-800 hover:text-white transition-colors text-sm font-medium text-left">
                <i class="fas fa-flag-checkered w-5 text-center"></i> Milestones & Courses
            </button>

            <div class="pt-6 pb-2">
                <p class="px-3 text-xs font-semibold text-slate-500 uppercase tracking-wider">Clinical Modules</p>
            </div>

            <div id="module-nav-links" class="space-y-1">
                <!-- Modules injected by JS -->
            </div>
        </nav>

        <div class="p-4 border-t border-slate-800 space-y-2">
            <button onclick="state.logout()"
                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-rose-600 hover:bg-rose-700 text-white rounded-lg transition-colors text-sm font-medium">
                <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
            <button onclick="showBackupModal()"
                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-amber-400 rounded-lg transition-colors text-sm font-medium">
                <i class="fas fa-download"></i> Backup Data
            </button>
            <button onclick="state.importData()"
                class="w-full flex items-center justify-center gap-2 px-3 py-2 bg-slate-800 hover:bg-slate-700 text-sky-400 rounded-lg transition-colors text-sm font-medium">
                <i class="fas fa-upload"></i> Restore Backup
            </button>
            <div class="text-center mt-2">
                <span class="text-xs text-slate-500">Cloud Sync Active</span>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <div id="main-layout" class="flex-1 flex flex-col min-h-screen w-full hidden">
        <!-- Mobile Header -->
        <header
            class="bg-teal-700 text-white shadow-md sticky top-0 z-30 md:hidden flex justify-between items-center p-4 no-print">
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="text-white focus:outline-none"><i
                        class="fas fa-bars text-xl"></i></button>
                <span class="font-bold">Portfolio</span>
            </div>
            <button onclick="window.print()"><i class="fas fa-print"></i></button>
        </header>

        <main id="app-container" class="flex-1 p-4 md:p-8 lg:px-16 w-full max-w-7xl mx-auto fade-in">
            <!-- Rendered by JS -->
        </main>
    </div>

    <!-- Quick Log FAB -->
    <button onclick="showQuickLogModal()"
        class="fixed bottom-6 right-6 w-14 h-14 bg-teal-600 hover:bg-teal-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all flex items-center justify-center text-2xl z-40 no-print hover:scale-105">
        <i class="fas fa-plus"></i>
    </button>

    <!-- AGENT UI: Chat Bubble & Window -->
    <div id="agent-bubble" class="fixed bottom-6 left-6 z-40 no-print">
        <button onclick="toggleAgentChat()" class="w-14 h-14 bg-indigo-600 hover:bg-indigo-700 text-white rounded-full shadow-lg hover:shadow-xl transition-all flex items-center justify-center text-xl group relative">
            <i class="fas fa-robot"></i>
            <span class="absolute -top-1 -right-1 w-4 h-4 bg-green-400 rounded-full border-2 border-white animate-pulse"></span>
            <span class="absolute right-full mr-3 top-1/2 -translate-y-1/2 bg-slate-800 text-white text-xs px-3 py-1 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap pointer-events-none">
                Need help?
            </span>
        </button>
    </div>

    <div id="agent-window" class="fixed bottom-24 left-6 w-96 max-w-[calc(100vw-3rem)] bg-white rounded-2xl shadow-2xl z-40 hidden no-print border border-slate-200 overflow-hidden flex flex-col" style="height: 500px;">
        <div class="bg-indigo-600 text-white p-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-robot"></i>
                <span class="font-bold">Portfolio Agent</span>
            </div>
            <button onclick="toggleAgentChat()" class="hover:bg-indigo-500 w-8 h-8 rounded-full flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="agent-chat-history" class="flex-1 p-4 overflow-y-auto space-y-4 bg-slate-50">
            <div class="flex gap-3">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0 text-indigo-600">
                    <i class="fas fa-robot text-sm"></i>
                </div>
                <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm border text-sm text-slate-600 max-w-[80%]">
                    Hello! I am your portfolio assistant. I can analyze your progress and find missing requirements. Try asking <strong>"What am I missing?"</strong> or <strong>"What's next?"</strong>
                </div>
            </div>
        </div>

        <div class="p-3 border-t bg-white">
            <form onsubmit="sendAgentMessage(event)" class="flex gap-2">
                <input type="text" id="agent-input" placeholder="Ask about your progress..." class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500">
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg px-4 py-2 transition-colors">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        // --- 1. BYPASS OLD SERVICE WORKERS ---
        try {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function (registrations) {
                    for (let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
        } catch (e) { }

        // --- 2. DATA CONFIGURATIONS ---
        const moduleConfigs = [
            {
                id: 'surgery', name: 'Surgery (Module 1)', color: 'bg-green-700', text: 'text-green-700', border: 'border-green-700', duration: '9 months',
                weeks: [
                    { id: 'w1', title: 'Trauma Assessment & Shock' }, { id: 'w2', title: 'Antibiotics & Pre-op Prep' },
                    { id: 'w3', title: 'Instruments & Sterilization' }, { id: 'w4', title: 'Theatre Setup (Case: Stab wound)' },
                    { id: 'w5', title: 'Acute Pain' }, { id: 'w6', title: 'Chronic Pain' },
                    { id: 'w7', title: 'Wounds & Suturing' }, { id: 'w8', title: 'Transfer Principles' },
                    { id: 'w9', title: 'Pyomyositis & Osteo' }, { id: 'w10', title: 'Chest Drains' },
                    { id: 'w11', title: 'Closed Fractures' }, { id: 'w12', title: 'Neurovascular & Secondary Intention' },
                    { id: 'w13', title: 'Dental/Airway Infections' }, { id: 'w14', title: 'Abscesses' },
                    { id: 'w15', title: 'Appendicitis' }, { id: 'w16', title: 'Laparotomy Basics' },
                    { id: 'w17', title: 'Gut Repair' }, { id: 'w18', title: 'Stomas & Ulcers' },
                    { id: 'w19', title: 'Bowel Obstruction' }, { id: 'w20', title: 'Casting & Splinting' },
                    { id: 'w21', title: 'Traction' }, { id: 'w22', title: 'Open Fractures' },
                    { id: 'w23', title: 'Dislocations' }, { id: 'w24', title: 'Upper Limb Trauma' },
                    { id: 'w25', title: 'Bleeding Control' }, { id: 'w26', title: 'Enucleation' },
                    { id: 'w27', title: 'Hernia Repair' }, { id: 'w28', title: 'Strangulated Hernia' },
                    { id: 'w29', title: 'Minor Procedures' }, { id: 'w30', title: 'Head & Spinal Injury' },
                    { id: 'w31', title: 'Burns' }, { id: 'w32', title: 'Ethics' }
                ],
                assignmentList: [
                    { title: '1. Cancer Pathophysiology', prompt: 'Staging and development in rural contexts.' },
                    { title: '2. Cancer Screening in PNG', prompt: 'Pros/cons of screening programs.' },
                    { title: '3. Blood Transfusion Protocols', prompt: 'Risks, safety, and rural alternatives.' },
                    { title: '4. Blood / Haemopoiesis', prompt: 'Blood cell development, splenomegaly pathology.' },
                    { title: '5. Cytokines', prompt: 'Role in wound healing, inflammation, haemostasis, neoplasia.' },
                    { title: '6. Wound Healing Physiology', prompt: 'Stages of healing in different tissues.' },
                    { title: '7. Hb & Oxygen Transport', prompt: 'Oxygen dissociation curve, respiratory failure types.' },
                    { title: '8. Genetics', prompt: 'Genetic defects, gene therapy, counselling.' },
                    { title: '9. Nerve Conduction', prompt: 'Peripheral nerve injuries, diagnosis, assessment.' },
                    { title: '10. Pain Pathways', prompt: 'Pathways, analgesics, local anaesthetics.' },
                    { title: '11. Urodynamics', prompt: 'Incontinence, spinal cord injury, bladder function.' },
                    { title: '12. CSF & ICP', prompt: 'Pathophysiology of raised intracranial pressure.' },
                    { title: '13. Calcium Homeostasis', prompt: 'Renal calculi, hypercalcemia, osteoporosis.' },
                    { title: '14. Liver Function', prompt: 'Portal hypertension, cirrhosis, ascites, encephalopathy.' },
                    { title: '15. Bile & Gallstones', prompt: 'Bile composition, gallbladder function, stones.' },
                    { title: '16. Oedema', prompt: 'Pathophysiology of unilateral leg swelling.' },
                    { title: '17. Thrombosis', prompt: 'Thrombosis, embolism, anticoagulants.' },
                    { title: '18. Gastric Secretion', prompt: 'Physiology, H. pylori, ulcer, cancer.' },
                    { title: '19. Surgical Infections', prompt: 'Osteomyelitis, HIV, TB, Necrotising Fasciitis.' },
                    { title: '20. Antibiotics Policy', prompt: 'Antibiotic policy recommendations and monitoring.' }
                ],
                requiredProcedures: [
                    { name: 'Pleural tap (thoracoscentesis)', target: 3 }, { name: 'Abdominal tap (parascentesis)', target: 2 },
                    { name: 'Pericardial tap (pericardioscentesis)', target: 1 }, { name: 'Emergency IV access including I/O', target: 3 },
                    { name: 'Needle thoracotomy', target: 2 }, { name: 'Insertion of a chest drain', target: 5 },
                    { name: 'Cervical spine stabilization & log rolling', target: 1 }, { name: 'Setting up IV drip & rapid infusion sets', target: 2 },
                    { name: 'Irrigating, decontaminating, immobilizing limb', target: 3 }, { name: 'Debriding a wound', target: 3 },
                    { name: 'Manage case of facial injury', target: 3 }, { name: 'Manage gun-shot wound', target: 2 },
                    { name: 'Simple nerve repair', target: 2 }, { name: 'Vascular injury (managed or observed)', target: 2 },
                    { name: 'Performing simple amputations', target: 3 }, { name: 'A proper surgical scrub', target: 1 },
                    { name: 'Learning to gown and glove', target: 1 }, { name: 'Surgical management of furuncle/carbuncle', target: 2 },
                    { name: 'Draining a pyomyositis', target: 3 }, { name: 'Drilling tibia in acute osteomyelitis', target: 1 },
                    { name: 'Draining pus/irrigation of knee joint', target: 2 }, { name: 'Incising a pulp space infection', target: 1 },
                    { name: 'Enlocating a dislocated finger', target: 1 }, { name: 'Managing a dislocated elbow', target: 1 },
                    { name: 'Managing a dislocated shoulder', target: 3 }, { name: 'Managing a dislocated hip', target: 2 },
                    { name: 'Managing a distal radius fracture', target: 3 }, { name: 'Managing a forearm fracture', target: 3 },
                    { name: 'Managing a fractured humerus', target: 3 }, { name: 'Managing a fractured tibia', target: 3 },
                    { name: 'Managing a fractured femur', target: 3 }, { name: 'Doing an appendicectomy', target: 3 },
                    { name: 'Surgical access to hip & irrigation', target: 1 }, { name: 'Surgical access to ankle & irrigation', target: 1 },
                    { name: 'Draining an empyema', target: 1 }, { name: 'Culdoscentesis and drain pelvic abscess PV', target: 1 },
                    { name: 'Entering the abdomen safely', target: 5 }, { name: 'Intestinal obstruction', target: 2 },
                    { name: 'Basic transverse loop colostomy', target: 1 }, { name: 'Repairing perforations in stomach/gut', target: 3 },
                    { name: 'End to end anastomosis small gut', target: 2 }, { name: 'Irrigating and closing the abdomen', target: 5 },
                    { name: 'Inserting a nasogastric tube', target: 3 }, { name: 'Basic volar slab for forearm', target: 3 },
                    { name: 'Basic dorsal slab for forearm', target: 1 }, { name: 'Applying a below elbow forearm cast', target: 3 },
                    { name: 'Applying an above elbow cast', target: 3 }, { name: 'Applying a slab to the lower leg', target: 3 },
                    { name: 'Applying a below knee cast', target: 3 }, { name: 'Applying an above knee cast', target: 3 },
                    { name: 'Inserting tibial Steinmann pin for traction', target: 2 }, { name: 'Applying skin traction to lower leg', target: 1 },
                    { name: 'Repair of epigastric hernia', target: 3 }, { name: 'Repair of umbilical hernia', target: 3 },
                    { name: 'Repair of inguinal hernia', target: 2 }, { name: 'Excision of lipoma', target: 3 },
                    { name: 'Excision of epidermal (sebaceous) cyst', target: 2 }, { name: 'Insertion of suprapubic catheter', target: 3 },
                    { name: 'Operation for hydrocoele', target: 1 }, { name: 'Managing a case of head injury', target: 3 },
                    { name: 'Performing cranial burr holes', target: 1 }, { name: 'Managing a case of spinal injury', target: 3 },
                    { name: 'Fitting a cervical spine collar', target: 1 }, { name: 'Interpreting Cervical spine films', target: 1 },
                    { name: 'First aid for head injury / coma position', target: 1 }, { name: 'Identifying neurosurgical instruments', target: 1 },
                    { name: 'Assessing extent and depth of burn', target: 3 }, { name: 'Splinting burns correctly', target: 2 },
                    { name: 'Initial burns surgery (debridement/escharotomy)', target: 3 }, { name: 'Performing a split skin graft', target: 3 }
                ]
            },
            {
                id: 'anaesthesia', name: 'Anaesthesiology (Module 2)', color: 'bg-slate-700', text: 'text-slate-700', border: 'border-slate-700', duration: '4 months',
                weeks: [
                    { id: 'w1', title: 'Machine Check & Equipment' }, { id: 'w2', title: 'Ketamine (Pharma & Use)' },
                    { id: 'w3', title: 'Propofol & Benzos' }, { id: 'w4', title: 'Pre-op Assessment' },
                    { id: 'w5', title: 'Opiates & Deferring Surgery' }, { id: 'w6', title: 'Chronic Pain' },
                    { id: 'w7', title: 'Spinal & LUSCS' }, { id: 'w8', title: 'Brachial Plexus Blocks' },
                    { id: 'w9', title: 'Wrist/Ankle Blocks' }, { id: 'w10', title: 'Neonatal Resuscitation' },
                    { id: 'w11', title: 'Cannot Intubate/Ventilate' }, { id: 'w12', title: 'IV Access' },
                    { id: 'w13', title: 'Cardiac Arrest' }, { id: 'w14', title: 'Handling Negative Outcomes' }
                ],
                caseReports: [
                    'A case requiring general anaesthesia with paralysis', 'A case of regional anaesthesia', 'A case of sepsis with haemodynamic instability',
                    'A complicated pregnancy that went to surgery', 'A major head injury', 'Diabetic patient requiring peri-operative BSL management',
                    'Patient requiring management of acute perioperative or chronic pain'
                ],
                assignmentList: [
                    { title: 'Surgical procedures with the surgeon as anaesthetist', prompt: 'Problems and solutions (1500-2500 words)' }
                ],
                requiredProcedures: [
                    { name: 'Cardiopulmonary resuscitation', target: 3 }, { name: 'Insertion of central line', target: 1 },
                    { name: 'Adult intubation', target: 10 }, { name: 'LMA insertion', target: 5 },
                    { name: 'Non instrumental airway management', target: 10 }, { name: 'Cricothyroidotomy', target: 1 },
                    { name: 'Tracheostomy', target: 1 }, { name: 'Spinal (pregnant)', target: 10 },
                    { name: 'Spinal (non-pregnant)', target: 10 }, { name: 'Caudal', target: 1 },
                    { name: 'Axillary block or brachial plexus block', target: 5 }, { name: 'Wrist block', target: 3 },
                    { name: 'Ankle blocks', target: 2 }, { name: 'Digital nerve block', target: 3 },
                    { name: 'Anaesthesia: Neonate', target: 2 }, { name: 'Anaesthesia: Infant (< 2yrs)', target: 3 },
                    { name: 'Anaesthesia: Toddler (2-5yrs)', target: 5 }, { name: 'Anaesthesia: Elderly >60 yrs', target: 3 },
                    { name: 'Anaesthesia: Pregnancy Induced Hypertension', target: 2 }, { name: 'Anaesthesia: Ruptured Ectopic Pregnancy', target: 2 },
                    { name: 'Anaesthesia: Trauma with major blood loss', target: 2 }, { name: 'Anaesthesia: Laparotomy (penetrating wound)', target: 2 },
                    { name: 'Anaesthesia: Severe Head Injury', target: 1 }, { name: 'Anaesthesia: Head or Neck', target: 2 },
                    { name: 'Anaesthesia: ENT or Dental', target: 2 }, { name: 'Anaesthesia: Neurosurgery', target: 1 },
                    { name: 'Non-ketamine neurolepsis', target: 5 }, { name: 'Ketamine', target: 10 }
                ]
            },
            {
                id: 'childhealth', name: 'Child Health (Module 3)', color: 'bg-orange-500', text: 'text-orange-500', border: 'border-orange-500', duration: '1 month',
                weeks: [
                    { id: 'w1', title: 'Milestones & Malnutrition' }, { id: 'w2', title: 'Pneumonia & Oxygen' },
                    { id: 'w3', title: 'Cardiac & Kidney' }, { id: 'w4', title: 'Newborn Exam' },
                    { id: 'w5', title: 'Ponsetti & Diarrhoea' }, { id: 'w6', title: 'Immunization' }
                ],
                caseReports: [
                    'Child with tuberculosis', 'Meningitis', 'Severe Acute Malnutrition', 'Severe diarrhoea with dehydration',
                    'Low birth weight neonate <2000gm', 'Child presenting with HIV infection and AIDS', 'Severe anaemia requiring transfusion'
                ],
                assignmentList: [
                    { title: '1. Severe Malnutrition', prompt: 'WHO recommendations and practical implementation in district hospital' },
                    { title: '2. Meningitis', prompt: 'Rationale for current standard treatment in children' },
                    { title: '3. Asthma', prompt: 'Ideal vs practical management at District Hospital' },
                    { title: '4. HIV/AIDS in Children', prompt: 'PMTCT, ART programs and district hospital challenges' },
                    { title: '5. Oxygen Therapy', prompt: 'Indications for pneumonia, supply problems and solutions' },
                    { title: '6. Neonatal Mortality', prompt: 'Reducing mortality at district and community levels' },
                    { title: '7. Immunization', prompt: 'Reasons for falling coverage and improvement strategies' }
                ],
                requiredProcedures: [
                    { name: 'Neonatal resuscitation', target: 4 }, { name: 'Management of LBW neonate', target: 4 },
                    { name: 'Intraosseous needle placement', target: 1 }, { name: 'Healthy Newborn examination', target: 5 },
                    { name: 'Ponsetti cast', target: 2 }, { name: 'IV access with splinting (child <5 yrs)', target: 5 },
                    { name: 'Assembly of oxygen bottle/regulator system', target: 1 }, { name: 'Insert/secure nasopharyngeal oxygen catheter', target: 2 },
                    { name: 'Give intradermal BCG vaccine', target: 5 }
                ]
            },
            {
                id: 'obs_gyn', name: 'Obs & Gynae (Module 4)', color: 'bg-pink-500', text: 'text-pink-500', border: 'border-pink-500', duration: '3 months',
                weeks: [
                    { id: 'w1', title: 'Menstrual Cycle' }, { id: 'w2', title: 'Contraception' },
                    { id: 'w3', title: 'Routine Antenatal' }, { id: 'w4', title: 'Basic USS' },
                    { id: 'w5', title: 'Miscarriage/Ectopic' }, { id: 'w6', title: 'Normal Labour' },
                    { id: 'w7', title: 'Partograms' }, { id: 'w8', title: 'CS Technique' },
                    { id: 'w9', title: 'APH & Pre-eclampsia' }, { id: 'w10', title: 'Failure to Progress' },
                    { id: 'w11', title: 'PPH' }, { id: 'w12', title: 'Puerperal Sepsis' },
                    { id: 'w13', title: 'Infertility' }, { id: 'w15', title: 'Ovarian Tumours' },
                    { id: 'w17', title: 'Endometrial CA' }, { id: 'w19', title: 'Cervical CA' },
                    { id: 'w21', title: 'Pelvic Sepsis' }, { id: 'w23', title: 'Pre-eclampsia/Eclampsia' },
                    { id: 'w26', title: 'PPH Advanced' }, { id: 'w29', title: 'Destructive Delivery' }
                ],
                caseReports: [
                    'Failure to progress in labour', 'Abnormal menstruation', 'Puerperal Sepsis',
                    'Antepartum haemorrhage OR ectopic pregnancy', 'Postpartum haemorrhage', 'Gynaecological malignancy'
                ],
                assignmentList: [
                    { title: '1. Family Planning', prompt: 'Options, attitudes and practical difficulties in rural areas' },
                    { title: '2. Supervised Birthing Rates', prompt: 'Reasons for low rates and health system improvements' },
                    { title: '3. Cervical Cancer', prompt: 'Types, causes, staging and treatment modalities' },
                    { title: '4. Cervical Cancer Prevention', prompt: 'Strategies, effectiveness and future possibilities' },
                    { title: '5. Ultrasound in Rural Areas', prompt: 'Utilization of new technology in O&G practice' },
                    { title: '6. Infertility', prompt: 'Types, causes, presentation frequency and cultural attitudes' }
                ],
                requiredProcedures: [
                    { name: 'Surgical management of ectopic pregnancy', target: 4 }, { name: 'Management of PPH (at least 1 with transfusion)', target: 6 },
                    { name: 'Obstructed labour requiring destructive delivery', target: 1 }, { name: 'Retained placenta and manual removal', target: 5 },
                    { name: 'Management of Placenta Praevia', target: 2 }, { name: 'Breech delivery', target: 5 },
                    { name: 'Ovarian cystectomy', target: 1 }, { name: 'Management of severe PET', target: 2 },
                    { name: 'Lower uterine segment Caesarean section', target: 6 }, { name: 'Vacuum extraction', target: 6 },
                    { name: 'Major placental abruption', target: 1 }, { name: 'Post-partum tubal ligation', target: 5 },
                    { name: 'Interval tubal ligation', target: 2 }, { name: 'ERPC for incomplete abortion', target: 6 },
                    { name: 'Dilatation and curettage', target: 2 }, { name: 'Paracervical block', target: 2 },
                    { name: 'Failure to progress and augmentation of labour', target: 6 }, { name: 'Insertion of IUD', target: 2 },
                    { name: 'Twin delivery (including internal version)', target: 4 }
                ]
            },
            {
                id: 'medicine', name: 'Internal Medicine (Module 5)', color: 'bg-blue-600', text: 'text-blue-600', border: 'border-blue-600', duration: '2 months',
                weeks: [
                    { id: 'w1', title: 'Diabetes' }, { id: 'w2', title: 'Antibiotics & Sepsis' },
                    { id: 'w3', title: 'Tuberculosis' }, { id: 'w4', title: 'Snake Bite & ECG' },
                    { id: 'w5', title: 'Hypertension & HIV' }, { id: 'w6', title: 'Asthma/COAD' }
                ],
                caseReports: ['Severe malaria', 'Severe Asthma or COAD', 'Epilepsy', 'Inflammatory polyarthritis', 'Myocardial Infarction', 'Tuberculosis'],
                assignmentList: [
                    { title: 'Part A: Chronic Respiratory Diseases', prompt: 'Management at district level and prevalence' },
                    { title: 'Part A: DOTS Programs', prompt: 'Issues conducting DOTS in rural vs urban locations' },
                    { title: 'Part A: Type 2 Diabetes', prompt: 'Prevalence and rural management differences' },
                    { title: 'Part A: Typhoid Fever', prompt: 'Peculiar issues of presentation, diagnosis and treatment' },
                    { title: 'Part A: Hypertension & Stroke', prompt: 'Prevention and Management' },
                    { title: 'Part A: Coronary Artery Disease', prompt: 'Prevalence, prevention, diagnosis and management' },
                    { title: 'Part A: HIV/AIDS', prompt: 'ART prescribing, community attitudes and district challenges' },
                    { title: 'Part A: Chronic Liver Disease', prompt: 'Prevalence, diagnosis, community beliefs and treatment' },
                    { title: 'Part A: Haemopoiesis/Coagulation', prompt: 'Diagnostic and management challenges at district hospital' },
                    { title: 'Part B: Cancer in PNG (2500 words)', prompt: 'Patterns of neoplasia, attitudes, diagnostic challenges, and palliative care' }
                ],
                requiredProcedures: [
                    { name: 'Severe malaria (one with renal impairment)', target: 4 }, { name: 'Asthma', target: 2 },
                    { name: 'COAD', target: 3 }, { name: 'Acute Myocardial Infarction', target: 3 },
                    { name: 'CVA', target: 2 }, { name: 'Congestive Cardiac Failure', target: 3 },
                    { name: 'Severe Hypertension', target: 1 }, { name: 'Anaphylaxis', target: 1 },
                    { name: 'Status Epilepticus', target: 1 }, { name: 'Snake bite envenomation (one with antivenom)', target: 2 },
                    { name: 'Tuberculosis (incl. extrapulmonary, relapse, resistant)', target: 6 }, { name: 'HIV/AIDS', target: 4 },
                    { name: 'Severe Sepsis', target: 2 }, { name: 'Acute hepatitis', target: 1 },
                    { name: 'Chronic liver disease and hepatoma', target: 2 }, { name: 'Severe community acquired pneumonia', target: 2 },
                    { name: 'Peptic Ulcer Disease and Gastritis', target: 1 }, { name: 'Drug Overdose or poisoning', target: 2 },
                    { name: 'Perform an ECG', target: 4 }, { name: 'Teach use of a metered dose inhaler', target: 2 },
                    { name: 'Create a spacer', target: 1 }, { name: 'Snake bite immobilization bandage', target: 1 },
                    { name: 'Lumbar puncture', target: 2 }
                ]
            },
            {
                id: 'psychiatry', name: 'Psychiatry (Module 6)', color: 'bg-purple-500', text: 'text-purple-500', border: 'border-purple-500', duration: '1 month',
                caseReports: ['Acute Psychosis (including post-partum psychosis)', 'Somatoform Disorder'],
                requiredProcedures: []
            },
            {
                id: 'publichealth', name: 'Public Health (Module 7)', color: 'bg-teal-500', text: 'text-teal-500', border: 'border-teal-500', duration: 'Longitudinal',
                assignmentList: [
                    { title: 'Part A: District Health Report (3500 words)', prompt: 'Comprehensive analysis of district health geography, administration, and epidemiology' },
                    { title: 'Part B: Outbreak of Food Poisoning', prompt: 'Management at a residential institution' },
                    { title: 'Part B: Disease Surveillance', prompt: 'Measles, polio, and investigating unknown deaths' },
                    { title: 'Part B: Domestic Violence', prompt: 'Epidemiology, contributing factors and costs in your district' },
                    { title: 'Part B: Immunization', prompt: 'Current coverage and improvement strategies' },
                    { title: 'Part B: Reproductive Health Services', prompt: 'Current services and outline plans for improvement' },
                    { title: 'Part B: Occupational/Environmental Health', prompt: 'Industries in your district (mining, agriculture)' }
                ],
                requiredProcedures: []
            },
            {
                id: 'eye_ent', name: 'Eye/ENT (Module 8)', color: 'bg-cyan-500', text: 'text-cyan-500', border: 'border-cyan-500', duration: '1 month',
                caseReports: ['Perforating eye injury', 'Acute red eye', 'Epistaxis', 'Chronic Suppurative Otitis Media'],
                requiredProcedures: [
                    { name: 'Remove a foreign body from the eye', target: 2 }
                ]
            },
            {
                id: 'lab', name: 'Laboratory (Module 9)', color: 'bg-indigo-500', text: 'text-indigo-500', border: 'border-indigo-500', duration: '1 month',
                assignmentList: [
                    { title: 'Skill: Cross-match', prompt: 'Demonstrate competency in blood cross-matching procedures.' },
                    { title: 'Skill: Malaria Stain', prompt: 'Demonstrate competency in preparing and reading malaria stains.' }
                ],
                requiredProcedures: [
                    { name: 'Blood grouping and cross-match', target: 4 }, { name: 'Finger prick BSL', target: 2 },
                    { name: 'Urine microscopy', target: 1 }, { name: 'Stool microscopy', target: 1 },
                    { name: 'HIV Rapid test', target: 2 }, { name: 'Giemsa stain', target: 2 }
                ]
            },
            {
                id: 'management', name: 'Management (Module 10)', color: 'bg-slate-600', text: 'text-slate-600', border: 'border-slate-600', duration: '4 weeks',
                assignmentList: [
                    { title: 'Management Systems at 3 Hospitals (3500 words)', prompt: 'Evaluate authority chains, legal basis, and decision making' }
                ],
                requiredProcedures: []
            }
        ];

        const milestoneConfigs = {
            research: [{ id: 'res_topic', label: 'Research Topic Approved' }, { id: 'res_data', label: 'Data Collection Completed' }, { id: 'res_submit', label: 'Research Submitted' }, { id: 'res_present', label: 'Research Presented' }],
            exams: [{ id: 'exam_part1', label: 'Part 1 Exam Passed' }, { id: 'exam_part2_written', label: 'Part 2 Written Passed' }, { id: 'exam_part2_clinical', label: 'Part 2 Clinical Passed' }],
            management: [{ id: 'mgmt_course', label: '4-Week Intensive Course Completed' }, { id: 'mgmt_assign', label: '3500 Word Assignment Completed' }],
            short_courses: [
                { id: 'sc_emst', label: 'Emergency Management Severe Trauma (EMST)' }, { id: 'sc_emsb', label: 'Emergency Management Severe Burns (EMSB)' },
                { id: 'sc_ccrisp', label: 'Care of Critically Injured Surgical Patient (CCRISP)' }, { id: 'sc_us', label: 'Basic Ultrasonography' },
                { id: 'sc_xray', label: 'Basic Radiography' }, { id: 'sc_als', label: 'Advanced Life Support' },
                { id: 'sc_paed', label: 'Paediatric Refresher' }, { id: 'sc_solar', label: 'Solar & Radio Maintenance Course' }
            ]
        };

        // --- 3. PORTFOLIO AGENT CLASS ---
        class PortfolioAgent {
            constructor(stateRef) {
                this.state = stateRef;
            }

            async ask(query) {
                query = query.toLowerCase().trim();
                
                if (query.includes('missing') || query.includes('need') || query.includes('requirement')) {
                    return this.analyzeMissing();
                }
                if (query.includes('progress') || query.includes('summary') || query.includes('report')) {
                    return this.generateSummary();
                }
                if (query.includes('focus') || query.includes('next') || query.includes('what should i do')) {
                    return this.suggestNextSteps();
                }
                if (query.includes('logged') || query.includes('recent') || query.includes('history')) {
                    return this.analyzeRecentLogs();
                }
                if (query.includes('help') || query.includes('how to')) {
                    return this.getHelp(query);
                }
                return this.getContextualTip();
            }

            analyzeMissing() {
                const activeModule = this.state.activeTab;
                const config = moduleConfigs.find(m => m.id === activeModule);
                
                if (!config || !config.requiredProcedures) {
                    let totalMissing = 0;
                    let criticalMissing = [];
                    
                    moduleConfigs.forEach(m => {
                        if(m.requiredProcedures) {
                            m.requiredProcedures.forEach(p => {
                                const count = this.state.procedureLog.filter(l => l.moduleId === m.id && l.procedure === p.name).length;
                                if (count < p.target) {
                                    totalMissing++;
                                    if (p.target >= 5 && count === 0) criticalMissing.push(`${p.name} (${m.name.split(' ')[0]})`);
                                }
                            });
                        }
                    });

                    return {
                        type: 'alert',
                        title: 'Gaps Found',
                        body: `You have **${totalMissing} procedure types** pending across all modules. \n\n**Start with these critical ones:** \n- ${criticalMissing.slice(0, 3).join('\n- ')}`,
                        actions: ['View Master Logbook']
                    };
                }

                let missing = [];
                config.requiredProcedures.forEach(p => {
                    const count = this.state.procedureLog.filter(l => l.moduleId === activeModule && l.procedure === p.name).length;
                    if (count < p.target) {
                        missing.push({ name: p.name, needed: p.target - count });
                    }
                });

                if (missing.length === 0) return { type: 'success', title: 'All Done!', body: `You have completed all required procedures for **${config.name}**!` };

                return {
                    type: 'list',
                    title: `Missing in ${config.name}`,
                    body: `You still need to log **${missing.length}** procedure types:`,
                    items: missing.sort((a,b) => b.needed - a.needed).slice(0, 5).map(m => `${m.name} (Need ${m.needed})`)
                };
            }

            generateSummary() {
                const total = this.state.procedureLog.length;
                const user = this.state.account.name;
                const year = this.state.account.year;
                const uniqueProcs = new Set(this.state.procedureLog.map(p => p.procedure)).size;
                
                let totalReq = 0;
                let totalMet = 0;
                moduleConfigs.forEach(m => {
                    if(m.requiredProcedures) {
                        m.requiredProcedures.forEach(p => {
                            totalReq++;
                            const count = this.state.procedureLog.filter(l => l.moduleId === m.id && l.procedure === p.name).length;
                            if (count >= p.target) totalMet++;
                        });
                    }
                });

                return {
                    type: 'report',
                    title: 'Portfolio Snapshot',
                    body: `**Trainee:** ${user} (Year ${year})\n**Total Logs:** ${total}\n**Unique Skills:** ${uniqueProcs}\n**Requirement Completion:** ${Math.round((totalMet/totalReq)*100)}%`,
                    actions: ['Print Summary']
                };
            }

            suggestNextSteps() {
                let worstModule = null;
                let lowestPct = 100;

                moduleConfigs.forEach(m => {
                    if (m.requiredProcedures && m.requiredProcedures.length > 0) {
                        const met = m.requiredProcedures.filter(p => {
                            const count = this.state.procedureLog.filter(l => l.moduleId === m.id && l.procedure === p.name).length;
                            return count >= p.target;
                        }).length;
                        const pct = (met / m.requiredProcedures.length) * 100;
                        if (pct < lowestPct) {
                            lowestPct = pct;
                            worstModule = m;
                        }
                    }
                });

                if (!worstModule) return { type: 'info', title: 'All Good!', body: 'You are making great progress everywhere!' };

                const missing = worstModule.requiredProcedures.find(p => {
                    const count = this.state.procedureLog.filter(l => l.moduleId === worstModule.id && l.procedure === p.name).length;
                    return count < p.target;
                });

                return {
                    type: 'action',
                    title: 'Recommended Focus',
                    body: `Your progress in **${worstModule.name}** is currently at ${Math.round(lowestPct)}%. \n\nTry to log a case of **${missing.name}** soon.`,
                    actions: [`Log ${missing.name}`]
                };
            }

            analyzeRecentLogs() {
                const recent = this.state.procedureLog.slice(-5).reverse();
                if (recent.length === 0) return { type: 'info', body: "No procedures logged yet." };
                
                return {
                    type: 'log',
                    title: 'Recent Activity',
                    body: "Here are your last 5 entries:",
                    items: recent.map(p => `${p.date}: ${p.procedure}`)
                };
            }

            getHelp(query) {
                return {
                    type: 'info',
                    title: 'How can I help?',
                    body: "I can help you with:\n- **'What am I missing?'** (Gaps analysis)\n- **'My progress'** (Summary report)\n- **'What's next?'** (Study suggestions)\n- **'Recent logs'** (Activity check)"
                };
            }

            getContextualTip() {
                const tab = this.state.activeTab;
                if (tab === 'dashboard') return this.generateSummary();
                if (tab === 'master_logbook') return this.analyzeMissing();
                return { type: 'info', body: "I'm here to help. Try asking 'What am I missing?'" };
            }
        }

        // --- 4. STATE MANAGEMENT (with Firebase) ---
        class AppState {
            constructor() {
                this.account = null;
                this.modules = {};
                this.procedureLog = [];
                this.milestones = {};
                this.activeTab = 'dashboard';
                this.listeners = [];
                this._loginHandled = false;
                this.driveToken = null;
                this.driveFolders = {};

                moduleConfigs.forEach(m => { this.modules[m.id] = { assignments: {}, weeks: {}, caseReports: {}, rotations: [] }; });

                this.initFirebase();
                this.loadData();
            }

            initFirebase() {
                const firebaseConfig = {
                    apiKey: "AIzaSyBhEln9kmgq22NnNHI83eUH7_d6S4F1O5s",
                    authDomain: "rural-mmed-logbook-3e095.firebaseapp.com",
                    projectId: "rural-mmed-logbook-3e095",
                    storageBucket: "rural-mmed-logbook-3e095.firebasestorage.app",
                    messagingSenderId: "826477177641",
                    appId: "1:826477177641:web:fe9de6e733b442fdffe538"
                };

                try {
                    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                    window.auth = firebase.auth();
                    window.db = firebase.firestore();

                    if (!window.auth.currentUser) {
                        window.auth.getRedirectResult().then(result => {
                            if (result.user) {
                                if (result.credential) this.driveToken = result.credential.accessToken;
                                this.handleCloudLogin(result.user);
                            }
                        }).catch(e => console.error("Redirect Error:", e));
                    }

                    window.auth.onAuthStateChanged(user => {
                        if (user) this.handleCloudLogin(user);
                        else {
                            this.account = null;
                            this.notify();
                        }
                    });
                } catch (e) {
                    console.error("Firebase Init Failed", e);
                    const stored = localStorage.getItem('mmed_tracker_v2_cloud');
                    if (stored) this.account = JSON.parse(stored).account;
                }
            }

            async handleCloudLogin(user) {
                if (this._loginHandled && this.account && this.account.id === user.uid) return;
                this._loginHandled = true;

                const loading = document.getElementById('loading');
                if (loading) loading.style.display = 'flex';

                try {
                    const doc = await window.db.collection('users').doc(user.uid).get();
                    const cloudData = doc.exists ? doc.data() : {};

                    this.account = {
                        name: cloudData.account?.name || user.displayName || "Dr. Trainee",
                        email: user.email,
                        id: user.uid,
                        year: cloudData.account?.year || 1,
                        location: cloudData.account?.location || "General Hospital",
                        lastBackup: Date.now()
                    };

                    if (cloudData.modules) this.modules = cloudData.modules;
                    if (cloudData.procedureLog) this.procedureLog = cloudData.procedureLog;
                    if (cloudData.milestones) this.milestones = cloudData.milestones;
                    if (cloudData.driveFolders) this.driveFolders = cloudData.driveFolders;

                    this.saveData(true);
                } catch (e) {
                    console.error("Sync Error", e);
                    this.account = { name: user.displayName || "Dr. User", email: user.email, id: user.uid, year: 1, location: "Offline Mode" };
                } finally {
                    if (loading) loading.style.display = 'none';
                    this.notify();
                    if (document.getElementById('login-container')) document.getElementById('login-container').classList.add('hidden');
                    if (document.getElementById('main-layout')) document.getElementById('main-layout').classList.remove('hidden');
                }
            }

            async driveApiFetch(url, options = {}) {
                if (!this.driveToken) { console.warn('No Drive token available'); return null; }
                const resp = await fetch(url, {
                    ...options,
                    headers: { 'Authorization': `Bearer ${this.driveToken}`, ...(options.headers || {}) }
                });
                if (!resp.ok) {
                    const err = await resp.text();
                    console.error('Drive API error:', resp.status, err);
                    if (resp.status === 401) { this.driveToken = null; }
                    return null;
                }
                return resp;
            }

            async ensureDriveFolder(name, parentId = null) {
                let q = `name='${name}' and mimeType='application/vnd.google-apps.folder' and trashed=false`;
                if (parentId) q += ` and '${parentId}' in parents`;
                const searchResp = await this.driveApiFetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)&spaces=drive`
                );
                if (searchResp) {
                    const data = await searchResp.json();
                    if (data.files && data.files.length > 0) return data.files[0].id;
                }
                const meta = { name, mimeType: 'application/vnd.google-apps.folder' };
                if (parentId) meta.parents = [parentId];
                const createResp = await this.driveApiFetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(meta)
                });
                if (createResp) {
                    const folder = await createResp.json();
                    return folder.id;
                }
                return null;
            }

            async initDriveFolders(moduleId) {
                if (!this.driveToken) return null;
                if (!this.driveFolders.root) {
                    this.driveFolders.root = await this.ensureDriveFolder('MMed Portfolio');
                    if (!this.driveFolders.root) return null;
                }
                if (!this.driveFolders[moduleId]) {
                    const config = moduleConfigs.find(m => m.id === moduleId);
                    const folderName = config ? config.name.split(' (')[0] : moduleId;
                    this.driveFolders[moduleId] = await this.ensureDriveFolder(folderName, this.driveFolders.root);
                }
                this.saveDriveFolders();
                return this.driveFolders[moduleId];
            }

            saveDriveFolders() {
                if (this.account?.id && window.db) {
                    window.db.collection('users').doc(this.account.id).set({ driveFolders: this.driveFolders }, { merge: true }).catch(e => console.error('Save folders error:', e));
                }
            }

            async uploadToDrive(file, moduleId) {
                const folderId = await this.initDriveFolders(moduleId);
                if (!folderId) return null;
                const metadata = { name: file.name, parents: [folderId] };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);
                const resp = await this.driveApiFetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,size,mimeType,webViewLink,createdTime',
                    { method: 'POST', body: form }
                );
                if (resp) return await resp.json();
                return null;
            }

            async listDriveFiles(moduleId) {
                const folderId = this.driveFolders[moduleId];
                if (!folderId || !this.driveToken) return [];
                const q = `'${folderId}' in parents and trashed=false`;
                const resp = await this.driveApiFetch(
                    `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name,size,mimeType,webViewLink,thumbnailLink,createdTime)&orderBy=createdTime desc&spaces=drive`
                );
                if (resp) {
                    const data = await resp.json();
                    return data.files || [];
                }
                return [];
            }

            async deleteDriveFile(fileId) {
                if (!this.driveToken) return false;
                const resp = await this.driveApiFetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, { method: 'DELETE' });
                return resp !== null;
            }

            loadData() {
                try {
                    const stored = localStorage.getItem('mmed_tracker_v2_cloud');
                    if (stored && stored !== "null") {
                        const data = JSON.parse(stored);
                        if (data && typeof data === 'object') {
                            if (data.account) this.account = data.account;
                            if (data.modules) this.modules = data.modules;
                            if (data.procedureLog) this.procedureLog = data.procedureLog;
                            if (data.milestones) this.milestones = data.milestones;
                        }
                    }
                } catch (e) { console.error("Local Load Failed", e); }
            }

            saveData(skipCloud = false) {
                const data = { account: this.account, modules: this.modules, procedureLog: this.procedureLog, milestones: this.milestones };
                localStorage.setItem('mmed_tracker_v2_cloud', JSON.stringify(data));

                if (!skipCloud && this.account && window.db && this.account.id) {
                    clearTimeout(this._saveTimeout);
                    this._saveTimeout = setTimeout(() => {
                        window.db.collection('users').doc(this.account.id).set(data, { merge: true }).catch(e => console.error("Cloud Save Failing:", e));
                    }, 1500);
                }
                this.notify();
            }

            signInGoogle() {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/drive.file');
                window.auth.signInWithPopup(provider)
                    .then(r => {
                        if (r.credential) this.driveToken = r.credential.accessToken;
                        this.handleCloudLogin(r.user);
                    })
                    .catch(e => {
                        console.warn("Popup blocked, trying redirect");
                        window.auth.signInWithRedirect(provider);
                    });
            }

            signInEmail() {
                const e = document.getElementById('login-email').value.trim();
                const p = document.getElementById('login-password').value;
                const errorEl = document.getElementById('login-error');
                const showError = msg => { errorEl.textContent = msg; errorEl.classList.remove('hidden'); };
                errorEl.classList.add('hidden');

                if (!e || !p) return showError('Please enter email and password.');

                const friendlyErrors = {
                    'auth/wrong-password': 'Incorrect password. Please try again.',
                    'auth/invalid-credential': 'Incorrect email or password. Please try again.',
                    'auth/invalid-email': 'Please enter a valid email address.',
                    'auth/too-many-requests': 'Too many attempts. Please wait a moment and try again.',
                    'auth/user-disabled': 'This account has been disabled. Contact your administrator.',
                    'auth/network-request-failed': 'Network error. Please check your internet connection.',
                    'auth/email-already-in-use': 'An account with this email already exists. Please sign in instead.',
                    'auth/weak-password': 'Password must be at least 6 characters.',
                    'auth/user-not-found': 'No account found with this email. Please sign up first.'
                };

                const isSignUp = this._isSignUpMode;

                if (isSignUp) {
                    const cp = document.getElementById('login-confirm-password').value;
                    if (p.length < 6) return showError('Password must be at least 6 characters.');
                    if (p !== cp) return showError('Passwords do not match.');

                    window.auth.createUserWithEmailAndPassword(e, p)
                        .then(r => {
                            const displayName = document.getElementById('login-name').value.trim();
                            if (displayName) {
                                r.user.updateProfile({ displayName }).then(() => this.handleCloudLogin(r.user));
                            } else {
                                this.handleCloudLogin(r.user);
                            }
                        })
                        .catch(err => showError(friendlyErrors[err.code] || err.message));
                } else {
                    window.auth.signInWithEmailAndPassword(e, p)
                        .catch(err => showError(friendlyErrors[err.code] || err.message));
                }
            }

            logout() {
                this._loginHandled = false;
                if (window.auth) window.auth.signOut();
                this.account = null;
                localStorage.removeItem('mmed_tracker_v2_cloud');
                location.reload();
            }

            exportData() {
                this.saveData(true);
                const dataStr = localStorage.getItem('mmed_tracker_v2_cloud');
                const blob = new Blob([dataStr || "{}"], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = 'mmed_backup_' + new Date().toISOString().split('T')[0] + '.json';
                a.click(); URL.revokeObjectURL(url);
            }

            async getGapiToken() {
                const provider = new firebase.auth.GoogleAuthProvider();
                provider.addScope('https://www.googleapis.com/auth/drive.file');
                try {
                    const result = await window.auth.signInWithPopup(provider);
                    return result.credential.accessToken;
                } catch (e) {
                    console.error("Token Error", e);
                    return null;
                }
            }

            async backupToDrive() {
                try {
                    document.getElementById('backupModal').classList.add('hidden');
                    document.getElementById('loading').classList.remove('hidden');

                    if (!this.driveToken) this.driveToken = await this.getGapiToken();
                    if (!this.driveToken) throw new Error('Could not get Google Drive access.');

                    const folderId = await this.ensureDriveFolder('MMed Portfolio');
                    if (!folderId) throw new Error('Could not create portfolio folder.');

                    this.saveData(true);
                    const dataStr = localStorage.getItem('mmed_tracker_v2_cloud');
                    const fileName = 'mmed_backup_' + new Date().toISOString().split('T')[0] + '.json';

                    const metadata = {
                        name: fileName,
                        parents: [folderId],
                        mimeType: 'application/json'
                    };

                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                    form.append('file', new Blob([dataStr], { type: 'application/json' }));

                    const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${this.driveToken}` },
                        body: form
                    });

                    if (!resp.ok) throw new Error(await resp.text());

                    document.getElementById('loading').classList.add('hidden');
                    alert(' Backup saved explicitly to Google Drive/MMed Portfolio!');
                } catch (err) {
                    document.getElementById('loading').classList.add('hidden');
                    console.error('Backup error:', err);
                    alert('Backup Failed: ' + err.message);
                }
            }

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const data = JSON.parse(ev.target.result);
                            if (!data || typeof data !== 'object') throw new Error('Invalid format');
                            if (confirm('This will replace all current data with the backup. Are you sure?')) {
                                if (data.account) this.account = data.account;
                                if (data.modules) this.modules = data.modules;
                                if (data.procedureLog) this.procedureLog = data.procedureLog;
                                if (data.milestones) this.milestones = data.milestones;
                                this.saveData();
                                renderApp();
                                alert('Backup restored successfully!');
                            }
                        } catch (err) {
                            alert('Failed to restore backup: Invalid file format.');
                            console.error('Import error:', err);
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            setTab(tab) {
                this.activeTab = tab;
                if (window.innerWidth <= 768) toggleSidebar();
                this.notify();
            }

            updateModuleData(moduleId, type, id, value) {
                if (type === 'week') {
                    if (!this.modules[moduleId].weeks[id]) this.modules[moduleId].weeks[id] = {};
                    if (typeof value === 'object') this.modules[moduleId].weeks[id] = { ...this.modules[moduleId].weeks[id], ...value };
                    else this.modules[moduleId].weeks[id].status = value;
                } else if (type === 'assignment') {
                    if (!this.modules[moduleId].assignments[id]) this.modules[moduleId].assignments[id] = {};
                    this.modules[moduleId].assignments[id] = { ...this.modules[moduleId].assignments[id], ...value };
                } else if (type === 'caseReport') {
                    this.modules[moduleId].caseReports[id] = value;
                }
                this.saveData();
            }

            addRotation(moduleId) {
                if (!this.modules[moduleId].rotations) this.modules[moduleId].rotations = [];
                this.modules[moduleId].rotations.push({ location: '', startDate: '', endDate: '' });
                this.saveData();
            }

            updateRotation(moduleId, index, field, value) {
                if (!this.modules[moduleId].rotations) return;
                this.modules[moduleId].rotations[index][field] = value;
                this.saveData();
            }

            deleteRotation(moduleId, index) {
                if (!this.modules[moduleId].rotations) return;
                if (confirm('Delete this rotation entry?')) {
                    this.modules[moduleId].rotations.splice(index, 1);
                    this.saveData();
                }
            }

            addProcedure(data) {
                this.procedureLog.push({ ...data, timestamp: Date.now() });
                this.saveData();
            }

            updateMilestone(category, id, value, date) {
                if (!this.milestones[category]) this.milestones[category] = {};
                this.milestones[category][id] = { status: value, date: date };
                this.saveData();
            }

            notify() { this.listeners.forEach(l => l()); }
            subscribe(l) { this.listeners.push(l); }
        }

        const state = new AppState();
        const agent = new PortfolioAgent(state); // Initialize Agent

        // HTML escape utility
        function esc(str) {
            const el = document.createElement('span');
            el.textContent = str || '';
            return el.innerHTML;
        }

        // --- 5. AGENT UI FUNCTIONS ---
        function toggleAgentChat() {
            const win = document.getElementById('agent-window');
            win.classList.toggle('hidden');
            if (!win.classList.contains('hidden')) {
                document.getElementById('agent-input').focus();
            }
        }

        async function sendAgentMessage(e) {
            e.preventDefault();
            const input = document.getElementById('agent-input');
            const query = input.value.trim();
            if (!query) return;

            const history = document.getElementById('agent-chat-history');

            // User Message
            history.innerHTML += `
                <div class="flex gap-3 justify-end">
                    <div class="bg-indigo-600 text-white p-3 rounded-lg rounded-tr-none shadow-sm text-sm max-w-[80%]">
                        ${esc(query)}
                    </div>
                </div>
            `;
            input.value = '';

            // Thinking
            const thinkingId = 'think-' + Date.now();
            history.innerHTML += `
                <div id="${thinkingId}" class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0 text-indigo-600"><i class="fas fa-robot text-sm"></i></div>
                    <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm border text-sm text-slate-400 italic">Analyzing portfolio...</div>
                </div>
            `;
            history.scrollTop = history.scrollHeight;

            // Process
            setTimeout(() => {
                const response = agent.ask(query);
                document.getElementById(thinkingId).remove();

                const responseHtml = formatAgentResponse(response);
                history.innerHTML += responseHtml;
                history.scrollTop = history.scrollHeight;
            }, 600);
        }

        function formatAgentResponse(res) {
            let bodyHtml = res.body
                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-slate-800">$1</strong>')
                .replace(/\n/g, '<br>');

            let itemsHtml = '';
            if (res.items) {
                itemsHtml = `<ul class="mt-2 space-y-1 text-slate-600">${res.items.map(i => `<li class="flex items-start gap-2"><i class="fas fa-angle-right text-indigo-400 mt-1 text-xs"></i> ${i}</li>`).join('')}</ul>`;
            }

            let actionsHtml = '';
            if (res.actions) {
                actionsHtml = `<div class="mt-3 flex flex-wrap gap-2">${res.actions.map(act => `
                    <button onclick="agentAction('${act}')" class="text-xs bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-semibold px-3 py-1 rounded-full border border-indigo-200 transition-colors">
                        ${act}
                    </button>
                `).join('')}</div>`;
            }

            return `
                <div class="flex gap-3">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center flex-shrink-0 text-indigo-600">
                        <i class="fas fa-robot text-sm"></i>
                    </div>
                    <div class="bg-white p-3 rounded-lg rounded-tl-none shadow-sm border text-sm text-slate-600 max-w-[85%]">
                        ${res.title ? `<div class="font-bold text-slate-800 mb-1">${res.title}</div>` : ''}
                        <div>${bodyHtml}</div>
                        ${itemsHtml}
                        ${actionsHtml}
                    </div>
                </div>
            `;
        }

        function agentAction(action) {
            if (action.includes('Log')) {
                const procName = action.replace('Log ', '');
                showQuickLogModal();
                setTimeout(() => {
                    document.getElementById('quickProcName').value = procName;
                }, 100);
            } else if (action.includes('Master Logbook')) {
                state.setTab('master_logbook');
                toggleAgentChat();
            } else if (action.includes('Print')) {
                window.print();
            }
        }

        // --- 6. UI RENDERING FUNCTIONS ---

        function renderSidebarLinks() {
            const container = document.getElementById('module-nav-links');
            container.innerHTML = moduleConfigs.map(m => `
                <button onclick="state.setTab('${m.id}')" id="tab-${m.id}" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-800 transition-colors text-sm text-left truncate">
                    <div class="w-3 h-3 rounded-full ${m.color}"></div>
                    <span class="truncate">${m.name.split(' (')[0]}</span>
                </button>
            `).join('');

            document.querySelectorAll('aside button').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white', 'border-l-4', 'border-teal-500');
                if (btn.id === `tab-${state.activeTab}`) {
                    btn.classList.add('bg-slate-800', 'text-white', 'border-l-4', 'border-teal-500', 'pl-2');
                }
            });
        }

        function renderDashboard() {
            const totalProcedures = state.procedureLog.length;
            const targetProcedures = moduleConfigs.reduce((acc, m) => acc + (m.requiredProcedures ? m.requiredProcedures.reduce((a, p) => a + p.target, 0) : 0), 0);
            const totalAssignments = Object.values(state.modules).reduce((acc, m) => acc + (m.assignments ? Object.values(m.assignments).filter(a => a.dateSubmitted).length : 0), 0);
            const targetAssignments = moduleConfigs.reduce((acc, m) => acc + (m.assignmentList ? m.assignmentList.length : 0), 0);

            const partText = state.account.year <= 3 ? 'Part 1 (Years 1-3)' : 'Part 2 (Years 4-6)';

            return `
                <div class="flex justify-between items-end mb-8 no-print">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Welcome, ${esc(state.account.name)}</h1>
                        <p class="text-slate-500 mt-1">MMed (Rural) &bull; Year ${state.account.year} &bull; <span class="font-medium text-teal-700">${partText}</span></p>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8 border-l-4 border-l-slate-800">
                    <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2"><i class="fas fa-user-circle text-slate-400 mr-2"></i>Trainee Profile & Current Rotation</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Name</label>
                            <input type="text" value="${esc(state.account.name || '')}" onchange="state.account.name=this.value; state.saveData(); renderApp();" class="w-full border border-slate-300 rounded p-2 outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Current Year</label>
                            <select onchange="state.account.year=parseInt(this.value); state.saveData(); renderApp();" class="w-full border border-slate-300 rounded p-2 outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                                ${[1, 2, 3, 4, 5, 6].map(y => `<option value="${y}" ${state.account.year === y ? 'selected' : ''}>Year ${y}</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Current Hospital</label>
                            <input type="text" placeholder="e.g. Kundiawa, Sir Joseph Nombri" value="${esc(state.account.location || '')}" onchange="state.account.location=this.value; state.saveData(); renderApp();" class="w-full border border-slate-300 rounded p-2 outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-teal-600">
                        <h3 class="text-slate-500 text-sm uppercase font-bold tracking-wider mb-2">Procedures Logged</h3>
                        <div class="flex items-end gap-2">
                            <span class="text-4xl font-black text-slate-800">${totalProcedures}</span>
                            <span class="text-slate-400 font-medium mb-1">/ ${targetProcedures} Total Req.</span>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 border-t-4 border-t-amber-600">
                        <h3 class="text-slate-500 text-sm uppercase font-bold tracking-wider mb-2">Assignments Submitted</h3>
                        <div class="flex items-end gap-2">
                            <span class="text-4xl font-black text-slate-800">${totalAssignments}</span>
                            <span class="text-slate-400 font-medium mb-1">/ ${targetAssignments} Required</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-8">
                    <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800"><i class="fas fa-history text-teal-600 mr-2"></i>Recent Clinical Logs</h3>
                    </div>
                    <div class="divide-y divide-slate-100">
                        ${state.procedureLog.slice().reverse().slice(0, 5).map(p => `
                            <div class="px-6 py-4 hover:bg-slate-50 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2">
                                <div>
                                    <div class="font-bold text-slate-800">${esc(p.procedure)} ${p.isOther ? '<span class="inline-block ml-2 px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider rounded-full bg-amber-100 text-amber-700 border border-amber-200">Other</span>' : ''}</div>
                                    <div class="text-sm text-slate-500">Module: ${moduleConfigs.find(m => m.id === p.moduleId)?.name || 'General'} &bull; Supervisor: ${esc(p.supervisor)}</div>
                                </div>
                                <div class="text-sm font-medium text-slate-500 flex items-center gap-1">
                                    <i class="far fa-calendar-alt"></i> ${p.date}
                                </div>
                            </div>
                        `).join('')}
                        ${state.procedureLog.length === 0 ? '<div class="p-8 text-center text-slate-500">No procedures logged yet. Use the + button to start.</div>' : ''}
                    </div>
                </div>
            `;
        }

        function renderMilestones() {
            return `
                <div class="flex justify-between items-end mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Milestones & Short Courses</h1>
                        <p class="text-slate-500 mt-1">Track major program requirements, exams, and professional development.</p>
                    </div>
                    <button onclick="toggleAllSections(this)" class="text-xs font-bold text-slate-500 hover:text-slate-700 bg-white border border-slate-200 rounded-lg px-3 py-1.5 shadow-sm hover:shadow transition-all flex items-center gap-2 no-print">
                        <i class="fas fa-compress-alt"></i>
                        <span>Collapse All</span>
                    </button>
                </div>
                <div class="space-y-6">
                    ${Object.keys(milestoneConfigs).map(cat => `
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <button onclick="toggleSection(this)" class="w-full px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center cursor-pointer hover:bg-slate-100 transition-colors text-left">
                                <div class="flex items-center gap-3">
                                    <i class="fas fa-chevron-down text-slate-400 text-xs section-chevron transition-transform duration-200"></i>
                                    <h3 class="font-bold text-slate-800 uppercase tracking-wider text-sm">${cat.replace('_', ' ')}</h3>
                                </div>
                                <span class="text-xs font-bold px-2.5 py-1 rounded-full bg-slate-200 text-slate-600">${milestoneConfigs[cat].length} items</span>
                            </button>
                            <div class="divide-y divide-slate-100">
                                ${milestoneConfigs[cat].map(m => {
                const mData = state.milestones[cat] && state.milestones[cat][m.id] ? state.milestones[cat][m.id] : {};
                const isDone = mData.status === 'Done' || mData.status === 'Passed';
                return `
                                        <div class="p-4 sm:px-6 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 transition-colors ${isDone ? 'bg-green-50' : 'hover:bg-slate-50'}">
                                            <span class="font-semibold ${isDone ? 'text-green-800' : 'text-slate-700'}">${m.label}</span>
                                            <div class="flex items-center gap-3">
                                                <select onchange="state.updateMilestone('${cat}','${m.id}',this.value, this.nextElementSibling.value)" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm font-medium outline-none focus:ring-2 focus:ring-teal-500 ${isDone ? 'bg-green-600 text-white border-green-600' : 'bg-white text-slate-600'}">
                                                    <option value="Not Started" ${!isDone ? 'selected' : ''}>Pending</option>
                                                    <option value="${cat === 'exams' ? 'Passed' : 'Done'}" ${isDone ? 'selected' : ''}>${cat === 'exams' ? 'Passed' : 'Done'}</option>
                                                </select>
                                                <input type="date" value="${mData.date || ''}" onchange="state.updateMilestone('${cat}','${m.id}',this.previousElementSibling.value,this.value)" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm outline-none focus:ring-2 focus:ring-teal-500 bg-white">
                                            </div>
                                        </div>
                                    `;
            }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderMasterLogbook() {
            return `
                <div class="flex justify-between items-end mb-8 no-print">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Master Logbook Checklist</h1>
                        <p class="text-slate-500 mt-1">Automatically tracks your progress against graduation requirements based on your logs.</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="toggleAllSections(this)" class="text-xs font-bold text-slate-500 hover:text-slate-700 bg-white border border-slate-200 rounded-lg px-3 py-1.5 shadow-sm hover:shadow transition-all flex items-center gap-2">
                            <i class="fas fa-compress-alt"></i>
                            <span>Collapse All</span>
                        </button>
                        <button onclick="window.print()" class="hidden md:flex items-center gap-2 bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 transition shadow-sm font-medium">
                            <i class="fas fa-print"></i> Print Summary
                        </button>
                    </div>
                </div>
                
                <div class="hidden print:block p-6 text-center border-b border-slate-200 bg-white mb-6">
                    <h2 class="text-2xl font-bold text-slate-800 uppercase tracking-widest">Master Logbook Summary</h2>
                    <div class="mt-4 flex justify-between text-left border border-slate-300 p-4 rounded-lg bg-slate-50 text-sm">
                        <div><p><strong>Trainee:</strong> ${esc(state.account.name)}</p><p><strong>Year of Training:</strong> Year ${state.account.year}</p></div>
                        <div class="text-right"><p><strong>Current Hospital:</strong> ${esc(state.account.location) || '-'}</p></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${moduleConfigs.filter(m => m.requiredProcedures && m.requiredProcedures.length > 0).map(m => {
                const otherLogs = state.procedureLog.filter(p => p.moduleId === m.id && p.isOther);
                const otherGroups = {};
                otherLogs.forEach(p => {
                    if (!otherGroups[p.procedure]) otherGroups[p.procedure] = 0;
                    otherGroups[p.procedure]++;
                });
                const metCount = m.requiredProcedures.filter(req => state.procedureLog.filter(p => p.moduleId === m.id && p.procedure === req.name).length >= req.target).length;
                const totalReq = m.requiredProcedures.length;
                const pctMet = Math.round((metCount / totalReq) * 100);
                return `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 break-inside-avoid overflow-hidden">
                        <button onclick="toggleSection(this)" class="w-full px-6 py-4 flex items-center justify-between cursor-pointer hover:bg-slate-50 transition-colors border-b border-slate-100 text-left">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-chevron-down text-slate-400 text-xs section-chevron transition-transform duration-200"></i>
                                <h3 class="font-bold ${m.text}">${m.name}</h3>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-16 bg-slate-200 rounded-full h-1.5">
                                    <div class="h-1.5 rounded-full ${metCount === totalReq ? 'bg-green-500' : 'bg-teal-500'}" style="width: ${pctMet}%"></div>
                                </div>
                                <span class="text-xs font-bold px-2 py-0.5 rounded-full ${metCount === totalReq ? 'bg-green-100 text-green-700' : 'bg-slate-200 text-slate-600'}">${metCount}/${totalReq}</span>
                            </div>
                        </button>
                        <div class="p-6">
                            <div class="space-y-3">
                                ${m.requiredProcedures.map(req => {
                    const count = state.procedureLog.filter(p => p.moduleId === m.id && p.procedure === req.name).length;
                    const isDone = count >= req.target;
                    const pct = Math.min(100, Math.round((count / req.target) * 100));
                    return `
                                    <div class="text-sm ${count === 0 ? 'print-hide-zero' : ''}">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="font-medium ${isDone ? 'text-green-700' : 'text-slate-700'}">${isDone ? '<i class="fas fa-check-circle text-green-500 mr-1.5 text-xs"></i>' : ''}${req.name}</span>
                                            <span class="font-bold ${isDone ? 'text-green-600' : 'text-slate-500'} w-12 text-right">${count} / ${req.target}</span>
                                        </div>
                                        <div class="w-full bg-slate-100 rounded-full h-1.5 no-print">
                                            <div class="h-1.5 rounded-full ${isDone ? 'bg-green-500' : 'bg-teal-500'}" style="width: ${pct}%"></div>
                                        </div>
                                    </div>
                                `;
                }).join('')}
                                ${Object.keys(otherGroups).length > 0 ? `
                                    <div class="mt-4 pt-3 border-t border-amber-200">
                                        <div class="flex items-center gap-2 mb-3">
                                            <span class="px-2 py-0.5 text-[10px] font-bold uppercase tracking-wider rounded-full bg-amber-100 text-amber-700 border border-amber-200">Other Procedures</span>
                                            <span class="text-xs text-slate-400">${otherLogs.length} logged</span>
                                        </div>
                                        ${Object.entries(otherGroups).map(([name, cnt]) => `
                                            <div class="text-sm flex justify-between items-center py-1">
                                                <span class="font-medium text-amber-800">${esc(name)}</span>
                                                <span class="font-bold text-amber-600">${cnt}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
                </div>
            `;
        }

        function renderModuleDetail(moduleId) {
            const config = moduleConfigs.find(m => m.id === moduleId);
            const data = state.modules[moduleId] || { assignments: {}, weeks: {}, caseReports: {} };
            const logs = state.procedureLog.filter(p => p.moduleId === moduleId);

            // Simplified rendering for brevity - same logic as original provided code
            // Includes Rotation, Documents, Weeks, Assignments, Procedures

            return `
                <div class="${config.color} rounded-2xl p-8 text-white mb-8 shadow-md">
                    <h1 class="text-3xl font-bold tracking-tight">${config.name}</h1>
                    <div class="flex gap-4 mt-3 text-white/80 text-sm font-medium">
                        <span><i class="far fa-clock mr-1"></i> ${config.duration}</span>
                        ${config.requiredProcedures ? `<span><i class="fas fa-notes-medical mr-1"></i> ${config.requiredProcedures.reduce((a, r) => a + r.target, 0)} Required Procedures</span>` : ''}
                    </div>
                </div>

                <div class="flex justify-end mb-4 no-print">
                    <button onclick="toggleAllSections(this)" class="text-xs font-bold text-slate-500 hover:text-slate-700 bg-white border border-slate-200 rounded-lg px-3 py-1.5 shadow-sm hover:shadow transition-all flex items-center gap-2">
                        <i class="fas fa-compress-alt"></i> <span>Collapse All</span>
                    </button>
                </div>

                ${config.requiredProcedures ? `
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 mb-8 no-print overflow-hidden">
                        <button onclick="toggleSection(this)" class="w-full px-6 py-4 flex items-center gap-3 cursor-pointer hover:bg-slate-50 transition-colors border-b border-slate-100 text-left">
                            <i class="fas fa-chevron-down text-slate-400 text-xs section-chevron transition-transform duration-200"></i>
                            <h3 class="text-lg font-bold text-slate-800">Required Procedures Checklist</h3>
                        </button>
                        <div class="p-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            ${config.requiredProcedures.map(req => {
                        const count = logs.filter(p => p.procedure === req.name).length;
                        const isDone = count >= req.target;
                        const pct = Math.min(100, Math.round((count / req.target) * 100));
                        return `
                                    <div class="border rounded-lg p-3 ${isDone ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-slate-200'}">
                                        <div class="flex justify-between items-start mb-1.5">
                                            <span class="text-xs font-semibold leading-tight pr-2 ${isDone ? 'text-green-800' : 'text-slate-700'}">${req.name}</span>
                                            <span class="text-xs font-bold shrink-0 ml-auto ${isDone ? 'text-green-600' : 'text-teal-600'}">${count} / ${req.target}</span>
                                        </div>
                                        <div class="w-full bg-slate-200 rounded-full h-1">
                                            <div class="${isDone ? 'bg-green-500' : 'bg-teal-500'} h-1 rounded-full transition-all" style="width: ${pct}%"></div>
                                        </div>
                                    </div>
                                `;
                    }).join('')}
                        </div>
                        </div>
                    </div>
                ` : ''}
                
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden mb-12">
                    <button onclick="toggleSection(this)" class="w-full px-6 py-4 border-b border-slate-100 bg-slate-50 flex justify-between items-center no-print cursor-pointer hover:bg-slate-100 transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-chevron-down text-slate-400 text-xs section-chevron transition-transform duration-200"></i>
                            <h3 class="font-bold text-slate-800">Module Procedure Log</h3>
                            <span class="px-2 py-0.5 rounded-full text-xs font-bold bg-slate-200 text-slate-700">${logs.length} Logged</span>
                        </div>
                    </button>
                    <div>
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 border-b border-slate-200 text-slate-500 uppercase text-xs">
                                <tr>
                                    <th class="px-6 py-3 font-semibold">Date</th>
                                    <th class="px-6 py-3 font-semibold">Procedure</th>
                                    <th class="px-6 py-3 font-semibold">Location</th>
                                    <th class="px-6 py-3 font-semibold">Supervisor</th>
                                    <th class="px-6 py-3 font-semibold print:w-48 text-right print:text-left">Signature</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                ${logs.slice().sort((a, b) => (b.date || '').localeCompare(a.date || '') || (b.timestamp || 0) - (a.timestamp || 0)).map(p => `
                                    <tr class="hover:bg-slate-50 print:h-20 break-inside-avoid">
                                        <td class="px-6 py-3 whitespace-nowrap text-slate-600 align-middle print:align-bottom print:pb-6">${esc(p.date)}</td>
                                        <td class="px-6 py-3 font-medium text-slate-800 align-middle print:align-bottom print:pb-6">${esc(p.procedure)}</td>
                                        <td class="px-6 py-3 text-slate-600 align-middle print:align-bottom print:pb-6 text-xs">${esc(p.location) || '-'}</td>
                                        <td class="px-6 py-3 text-slate-600 align-middle print:align-bottom print:pb-6">${esc(p.supervisor)}</td>
                                        <td class="px-6 py-3 align-middle print:align-bottom">
                                            <div class="hidden print:block border-b-2 border-slate-400 w-full mb-6"></div>
                                            <div class="flex items-center justify-end gap-3 no-print">
                                                <button onclick="editProcedure(${p.timestamp})" class="text-slate-400 hover:text-teal-600 transition-colors" title="Edit entry"><i class="fas fa-pen text-xs"></i></button>
                                                <button onclick="deleteProcedure(${p.timestamp})" class="text-slate-400 hover:text-rose-600 transition-colors" title="Delete entry"><i class="fas fa-trash text-xs"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('') || `<tr><td colspan="5" class="px-6 py-8 text-center text-slate-400">No procedures logged for this module.</td></tr>`}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // --- 7. CORE INTERACTION FUNCTIONS ---

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('mobile-overlay').classList.toggle('hidden');
        }

        function toggleSection(btn) {
            const content = btn.nextElementSibling;
            if (!content) return;
            const isCollapsed = btn.classList.toggle('section-collapsed');
            content.style.display = isCollapsed ? 'none' : '';
        }

        function toggleAllSections(masterBtn) {
            const container = document.getElementById('app-container');
            if (!container) return;
            const sectionBtns = container.querySelectorAll('[onclick="toggleSection(this)"]');
            const icon = masterBtn.querySelector('i');
            const label = masterBtn.querySelector('span');
            const isCurrentlyExpanded = label.textContent.trim() === 'Collapse All';

            sectionBtns.forEach(btn => {
                const content = btn.nextElementSibling;
                if (!content) return;
                if (isCurrentlyExpanded) {
                    btn.classList.add('section-collapsed');
                    content.style.display = 'none';
                } else {
                    btn.classList.remove('section-collapsed');
                    content.style.display = '';
                }
            });

            if (isCurrentlyExpanded) {
                icon.className = 'fas fa-expand-alt';
                label.textContent = 'Expand All';
            } else {
                icon.className = 'fas fa-compress-alt';
                label.textContent = 'Collapse All';
            }
        }

        function deleteProcedure(timestamp) {
            if (confirm("Delete this log entry?")) {
                state.procedureLog = state.procedureLog.filter(p => p.timestamp !== timestamp);
                state.saveData();
                renderApp();
            }
        }

        function editProcedure(timestamp) {
            const entry = state.procedureLog.find(p => p.timestamp === timestamp);
            if (!entry) return;

            const modal = document.createElement('div');
            modal.id = 'editProcModal';
            modal.className = 'fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm';

            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                    <div class="px-6 py-4 bg-amber-50 border-b border-amber-100 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-amber-800"><i class="fas fa-pen text-amber-500 mr-2"></i>Edit Log Entry</h2>
                        <button onclick="document.getElementById('editProcModal').remove()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                    </div>
                    <form onsubmit="event.preventDefault(); saveEditedProcedure(${timestamp}, this);" class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Date</label>
                                <input type="date" name="date" value="${entry.date || ''}" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Module</label>
                                <input type="text" value="${esc(moduleConfigs.find(m => m.id === entry.moduleId)?.name || entry.moduleId)}" disabled class="w-full border border-slate-200 rounded-lg px-3 py-2 bg-slate-50 text-slate-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Procedure</label>
                            <input type="text" name="procedure" value="${esc(entry.procedure || '')}" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-amber-500">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Location/Hospital</label>
                                <input type="text" name="location" value="${esc(entry.location || '')}" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-amber-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Supervisor</label>
                                <input type="text" name="supervisor" value="${esc(entry.supervisor || '')}" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-amber-500">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 rounded-lg mt-2 shadow-md transition">Save Changes</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
        }

        function saveEditedProcedure(timestamp, form) {
            const entry = state.procedureLog.find(p => p.timestamp === timestamp);
            if (!entry) return;
            entry.date = form.date.value;
            entry.procedure = form.procedure.value;
            entry.location = form.location.value;
            entry.supervisor = form.supervisor.value;
            const config = moduleConfigs.find(m => m.id === entry.moduleId);
            entry.isOther = config?.requiredProcedures ? !config.requiredProcedures.some(r => r.name === entry.procedure) : true;
            state.saveData();
            document.getElementById('editProcModal').remove();
            renderApp();
        }

        function togglePassword(inputId, btn) {
            const input = document.getElementById(inputId);
            const icon = btn.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function toggleAuthMode(e) {
            if (e) e.preventDefault();
            const isSignUp = !state._isSignUpMode;
            state._isSignUpMode = isSignUp;

            document.getElementById('signup-name-field').classList.toggle('hidden', !isSignUp);
            document.getElementById('confirm-password-field').classList.toggle('hidden', !isSignUp);
            document.getElementById('auth-submit-btn').textContent = isSignUp ? 'Create Account' : 'Sign In';
            document.getElementById('login-subtitle').textContent = isSignUp ? 'Create your portfolio account' : 'Please sign in to continue';
            document.getElementById('auth-toggle').innerHTML = isSignUp
                ? 'Already have an account? <a href="#" onclick="toggleAuthMode(event)" class="text-teal-600 font-semibold hover:text-teal-700">Sign In</a>'
                : 'Don\'t have an account? <a href="#" onclick="toggleAuthMode(event)" class="text-teal-600 font-semibold hover:text-teal-700">Sign Up</a>';
            document.getElementById('login-error').classList.add('hidden');
        }

        window.updateProcList = (moduleId) => {
            const module = moduleConfigs.find(m => m.id === moduleId);
            const datalist = document.getElementById('proc-datalist');
            if (datalist && module && module.requiredProcedures) {
                datalist.innerHTML = module.requiredProcedures.map(p => `<option value="${p.name.replace(/"/g, '&quot;')}">`).join('');
            } else if (datalist) {
                datalist.innerHTML = '';
            }
        };

        function showBackupModal() {
            const modal = document.getElementById('backupModal');
            if (modal) {
                modal.classList.remove('hidden');
            } else {
                alert('Backup modal not found. Please reload.');
            }
        }

        function showQuickLogModal() {
            const modal = document.createElement('div');
            modal.id = 'quickLogModal';
            modal.className = 'fixed inset-0 bg-slate-900 bg-opacity-60 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm';

            const lastSup = state.procedureLog.length > 0 ? state.procedureLog[state.procedureLog.length - 1].supervisor : '';

            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                    <div class="px-6 py-4 bg-teal-50 border-b border-teal-100 flex justify-between items-center">
                        <h2 class="text-xl font-bold text-teal-800"><i class="fas fa-bolt text-amber-500 mr-2"></i> Quick Log Procedure</h2>
                        <button onclick="document.getElementById('quickLogModal').remove()" class="text-slate-400 hover:text-slate-600 text-2xl leading-none">&times;</button>
                    </div>
                    <form onsubmit="event.preventDefault();submitQuickLog(this);" class="p-6 space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Module</label>
                                <select name="module" required onchange="updateProcList(this.value)" class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-teal-500">
                                    <option value="" disabled selected>Select Module</option>
                                    ${moduleConfigs.map(m => `<option value="${m.id}" ${state.activeTab === m.id ? 'selected' : ''}>${m.name.split(' (')[0]}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Date</label>
                                <input type="date" name="date" required value="${new Date().toISOString().split('T')[0]}" class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-teal-500">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">Procedure</label>
                            <input type="text" id="quickProcName" name="procedure" list="proc-datalist" placeholder="Type or select from list..." required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-teal-500">
                            <datalist id="proc-datalist"></datalist>
                            <p class="text-xs text-slate-500 mt-1">Select a required procedure, or type any procedure name to log it under "Others".</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Location/Hospital</label>
                                <input type="text" name="location" placeholder="e.g. Kundiawa" value="${esc(state.account.location || '')}" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-teal-500">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">Supervisor</label>
                                <input type="text" name="supervisor" placeholder="Dr. Name" value="${esc(lastSup)}" required class="w-full border border-slate-300 rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-teal-500">
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg mt-2 shadow-md transition">Save Log Entry</button>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });

            if (state.activeTab && moduleConfigs.find(m => m.id === state.activeTab)) {
                updateProcList(state.activeTab);
            }
            setTimeout(() => document.getElementById('quickProcName').focus(), 100);
        }

        window.submitQuickLog = form => {
            const modId = form.module.value;
            const procName = form.procedure.value;
            const modConfig = moduleConfigs.find(m => m.id === modId);
            const isOther = !modConfig?.requiredProcedures?.some(rp => rp.name === procName);
            state.addProcedure({
                moduleId: modId,
                date: form.date.value,
                procedure: procName,
                location: form.location.value,
                supervisor: form.supervisor.value,
                isOther: isOther
            });
            document.getElementById('quickLogModal').remove();

            const toast = document.createElement('div');
            toast.innerHTML = `<div class="bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl font-medium border border-slate-700 flex items-center gap-3"><i class="fas fa-check-circle text-green-400"></i> Procedure Logged Successfully</div>`;
            toast.className = 'fixed bottom-24 right-6 z-50 fade-in';
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.5s'; setTimeout(() => toast.remove(), 500); }, 2500);
            renderApp();
        };

        // --- 8. SAFE RENDERER ---
        function renderApp() {
            try {
                const loginContainer = document.getElementById('login-container');
                const mainLayout = document.getElementById('main-layout');
                const fab = document.querySelector('button[onclick="showQuickLogModal()"]');

                if (!state.account) {
                    if (loginContainer) loginContainer.classList.remove('hidden');
                    if (mainLayout) mainLayout.classList.add('hidden');
                    if (fab) fab.classList.add('hidden');
                    return;
                }

                if (loginContainer) loginContainer.classList.add('hidden');
                if (mainLayout) mainLayout.classList.remove('hidden');
                if (fab) fab.classList.remove('hidden');

                renderSidebarLinks();
                const container = document.getElementById('app-container');

                if (state.activeTab === 'dashboard') container.innerHTML = renderDashboard();
                else if (state.activeTab === 'milestones') container.innerHTML = renderMilestones();
                else if (state.activeTab === 'master_logbook') container.innerHTML = renderMasterLogbook();
                else container.innerHTML = renderModuleDetail(state.activeTab);

                window.scrollTo(0, 0);
            } catch (error) {
                console.error("Render error:", error);
                document.getElementById('app-container').innerHTML = `
                    <div class="p-8 text-center max-w-lg mx-auto mt-12 bg-white rounded-2xl shadow-xl border border-slate-200">
                        <div class="text-rose-500 text-5xl mb-4"><i class="fas fa-exclamation-triangle"></i></div>
                        <h2 class="text-2xl font-bold text-slate-800 mb-2">Something went wrong</h2>
                        <button onclick="localStorage.clear(); window.location.reload();" class="bg-rose-600 text-white px-6 py-3 rounded-lg font-bold shadow-md hover:bg-rose-700 transition w-full">Reset App Data</button>
                    </div>
                `;
            }
        }

        // Init
        state.subscribe(renderApp);
        document.addEventListener('DOMContentLoaded', () => { renderApp(); });

    </script>
</body>

</html>